## 项目需求分析

### 1. 项目概述

本项目 `huali-edu` 是一个基于 Django 框架的教育辅助系统，主要功能围绕作业评分和管理展开。它集成了 AI 评分、Excel 成绩登记、文件管理和版本控制等功能，旨在提高教师批改作业的效率和准确性。

### 2. 核心功能

*   **用户认证与权限管理**:
    *   支持用户登录和认证。
    *   区分普通用户和教职工用户，并根据权限控制视图访问。
    *   提供用户管理界面（通过 Django Admin）。
*   **作业文件管理**:
    *   支持上传、存储和管理学生提交的作业文件（主要是 `.docx` 格式）。
    *   能够从配置的基础目录中读取和展示文件目录结构。
    *   提供文件内容预览功能（支持 `.docx`、`.pdf`、`.xlsx`、文本和图片）。
    *   支持文件下载。
*   **AI 智能评分**:
    *   集成 AI 模型对作业内容进行评分和生成评价。
    *   支持单个文件和批量文件的 AI 评分。
    *   能够处理 AI 评分过程中的错误和异常。
*   **成绩登记与管理**:
    *   能够读取和写入 Excel 格式的平时成绩登记表。
    *   支持根据作业目录名和学生姓名，将 AI 评分或手动评分登记到 Excel 表格中。
    *   能够处理 Excel 文件不存在或学生未找到的情况。
    *   支持根据文件名提取学生姓名和作业次数。
*   **教师评价**:
    *   支持教师对作业添加和保存文字评价。
    *   能够从文件中读取已有的教师评价。
*   **仓库管理**:
    *   管理 Git 仓库信息，包括名称、URL、分支等。
    *   支持仓库的克隆和分支切换。
    *   能够根据 URL 自动生成仓库名称。
    *   支持 SSH 协议的仓库克隆。
*   **系统配置**:
    *   提供全局配置，包括 HTTPS 认证信息、SSH 私钥内容、仓库克隆基础目录等。
    *   支持通过管理界面修改和保存配置。
*   **日志记录**:
    *   系统各模块（视图、文件处理、成绩登记等）均有详细的日志记录，便于问题排查和系统监控。

### 3. 技术栈

*   **后端框架**: Django
*   **数据库**: SQLite (测试环境), MySQL/PostgreSQL (根据 `mysqlclient` 和 `psycopg2` 依赖推断可能支持)
*   **异步任务**: Celery, Redis (作为消息代理和结果存储)
*   **文件处理**: `python-docx` (处理 Word 文档), `openpyxl` (处理 Excel 文件), `mammoth` (Word 文档转 HTML)
*   **版本控制集成**: `GitPython`
*   **AI 服务集成**: `volcenginesdkarkruntime` (火山引擎 Ark 运行时 SDK)
*   **前端**: HTML, CSS (Bootstrap), JavaScript (jQuery, jstree)
*   **其他库**: `pandas` (数据处理), `requests` (HTTP 请求), `pillow` (图像处理), `lxml` (XML 处理) 等。
*   **开发工具**: `pytest` (单元测试), `pip-tools` (依赖管理)
*   **部署**: Docker (根据 `Dockerfile` 和 `docker-compose.yml` 推断)

### 4. 非功能性需求

*   **安全性**:
    *   用户认证和授权机制 (`login_required`, `is_staff` 检查)。
    *   CSRF 防护 (`csrf_exempt` 装饰器)。
    *   文件路径安全检查 (`is_safe_path` 函数)。
    *   敏感信息（如 API 密钥）的配置和管理。
*   **性能**:
    *   目录文件数量缓存 (`directory_file_count_cache`)。
    *   批量处理功能 (`batch_ai_score`)。
    *   数据库迁移和优化。
*   **可用性**:
    *   直观的 Web 界面，便于教师操作。
    *   清晰的错误提示和日志信息。
*   **可维护性与可扩展性**:
    *   模块化的代码结构。
    *   使用 Django ORM 进行数据库操作。
    *   日志记录有助于调试和问题定位。
*   **兼容性**:
    *   支持多种文件类型（`.docx`, `.pdf`, `.xlsx`, 文本, 图片）。
    *   支持不同的 Git 协议（HTTPS, SSH）。
*   **鲁棒性**:
    *   对文件操作、AI 评分等可能出错的环节进行了异常处理。

### 5. 数据模型概览

*   **Student**: 学生信息 (学号, 姓名, 班级)
*   **Assignment**: 作业信息 (名称, 描述, 截止日期)
*   **Submission**: 学生提交记录 (学生, 作业, 提交时间, 成绩, 状态, 评论, 仓库 URL, 教师评价)
*   **GlobalConfig**: 全局配置 (HTTPS 认证, SSH 密钥, 仓库基础目录)
*   **Repository**: 仓库信息 (名称, URL, 分支, 所有者, 最后同步时间)
