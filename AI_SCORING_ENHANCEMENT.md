# AI评分功能增强

## 概述

本次更新为作业评分系统的AI评分功能添加了重复评分检查机制，确保已经评分的作业不会被重复进行AI评分。

## 修改内容

### 1. 后端修改

#### 单个文件AI评分 (`ai_score_view`)
- 在开始AI评分之前，先调用 `get_file_grade_info()` 检查文件是否已有评分
- 如果文件已有评分，返回400状态码和相应的错误信息
- 错误信息格式：`"该作业已有评分：{grade}，无需重复评分"`

#### 批量AI评分 (`batch_ai_score_view`)
- 在处理每个文件之前，检查该文件是否已有评分
- 对于已有评分的文件，跳过AI评分并在结果中标记为失败
- 在结果中提供详细的错误信息说明跳过原因

#### 评分检测逻辑修复
- 修复了 `get_file_grade_info()` 函数中表格单元格索引检测的bug
- 使用 `enumerate()` 来正确获取单元格索引，确保能准确检测到表格中的评分

### 2. 前端修改

#### 错误处理优化
- 改进了单个AI评分和批量AI评分的错误处理逻辑
- 更好地解析和显示服务器返回的错误信息
- 针对不同的HTTP状态码提供更准确的错误提示

### 3. 测试用例

#### 新增测试用例
- `test_ai_score_view_already_graded`: 测试单个文件已有评分时的处理
- `test_batch_ai_score_view_with_graded_files`: 测试批量评分中包含已有评分文件的处理

#### 测试覆盖
- 验证已有评分的文件会被正确跳过
- 验证错误信息包含具体的评分信息
- 验证批量评分中混合文件（有评分和无评分）的处理

## 功能特点

1. **智能检测**: 能够检测Word文档表格中和段落中的评分
2. **支持多种评分格式**: 支持字母评分（A、B、C、D、E）和文字评分（优秀、良好、中等、及格、不及格）
3. **用户友好**: 提供清晰的错误信息，告知用户具体的评分情况
4. **批量处理**: 在批量AI评分中，只对有评分的文件跳过，其他文件正常处理
5. **向后兼容**: 不影响现有的AI评分功能，只是增加了检查逻辑

## 使用场景

- 防止教师重复对同一作业进行AI评分
- 避免覆盖已有的手动评分
- 提高批量评分的效率，只处理未评分的作业
- 为用户提供清晰的操作反馈

## 技术实现

- 使用现有的 `get_file_grade_info()` 函数进行评分检测
- 在AI评分流程开始前进行预检查
- 通过HTTP状态码和JSON响应传递错误信息
- 前端根据响应状态和内容显示相应的用户提示

## 教师评价功能增强

### 1. 自动载入评价内容
- 点击教师评价按钮时，模态框会自动载入当前文件的所有评价内容
- 不区分人工评分和AI评分，统一显示所有类型的评价
- 支持多种评价格式：教师评价、AI评价、评价等

### 2. 评价内容识别
- **Word文档**：识别段落中的各种评价标题和内容
- **文本文件**：识别行中的评价标记和内容
- **智能合并**：将多个评价内容合并显示，用段落分隔

### 3. 用户体验优化
- **自动加载**：模态框显示时自动加载评价内容，无需手动操作
- **直接编辑**：评价内容自动载入输入框，用户可以直接修改现有评价
- **界面简洁**：删除了冗余的显示区域，只保留输入框
- **实时更新**：保存新评价后自动刷新显示内容
- **操作便捷**：支持AI评价和人工评价的统一编辑，提升工作效率
- **输入优化**：增加输入框行数，方便编辑长评价内容
- **调试优化**：添加详细的调试日志，便于问题诊断
- **状态提示**：当文件中没有评价时，显示友好的提示信息
- **统一提取**：不区分教师评价和AI评价，统一提取文件中的评价内容
- **统一写入**：AI评分和人工评分使用相同的文件写入逻辑，确保一致性

### 4. 统一函数优化
- **统一写入函数**：`write_grade_and_comment_to_file()` 函数统一处理评分和评价的写入
- **智能覆盖**：自动删除现有的评分和评价内容，避免重复
- **格式统一**：AI评分和人工评分使用相同的格式和逻辑
- **兼容性保持**：保留原有的 `save_teacher_comment_logic()` 和 `add_grade_to_file_logic()` 函数作为兼容性接口
- **Excel登记**：统一的Excel成绩登记逻辑，支持批量操作

### 5. 代码复用优化
- **通用工具函数**：创建了 `get_base_directory()`、`validate_file_path()`、`validate_user_permissions()` 等通用函数
- **统一响应格式**：`create_error_response()` 和 `create_success_response()` 函数统一处理API响应
- **文件操作工具**：`read_file_content()` 和 `get_file_extension()` 函数简化文件操作
- **装饰器模式**：`@require_staff_user` 和 `@validate_file_operation` 装饰器简化视图函数
- **代码简化**：视图函数代码行数减少约50%，提高可读性和维护性

### 6. 无数据库依赖
- 所有评价内容直接从文件中读取，不依赖数据库存储
- 评分过程完全基于文件操作，确保数据一致性
- 支持离线操作，不要求数据库连接

## 代码优化详细说明

### 1. 通用工具函数

#### 基础目录管理
```python
def get_base_directory():
    """获取基础目录路径"""
    config = GlobalConfig.objects.first()
    if not config or not config.repo_base_dir:
        logger.error("未配置仓库基础目录")
        return None
    return os.path.expanduser(config.repo_base_dir)
```

#### 文件路径验证
```python
def validate_file_path(file_path, base_dir=None):
    """验证文件路径的有效性和安全性"""
    # 返回 (is_valid, full_path, error_message)
```

#### 用户权限验证
```python
def validate_user_permissions(request):
    """验证用户权限"""
    # 返回 (is_valid, error_message)
```

### 2. 统一响应处理

#### 错误响应
```python
def create_error_response(message, status_code=400, response_format="status"):
    """创建统一的错误响应"""
```

#### 成功响应
```python
def create_success_response(data=None, message="操作成功", response_format="status"):
    """创建统一的成功响应"""
```

### 3. 装饰器模式

#### 用户权限装饰器
```python
@require_staff_user
def some_view(request):
    # 自动验证用户权限
    pass
```

#### 文件操作装饰器
```python
@validate_file_operation(file_path_param="path", require_write=True)
def some_view(request):
    # 自动验证文件路径和权限
    full_path = request.validated_file_path
    pass
```

### 4. 优化效果

#### 代码行数对比
- **优化前**：`add_grade_to_file` 函数约80行
- **优化后**：`add_grade_to_file` 函数约30行
- **减少比例**：约62.5%

#### 重复代码消除
- 消除了多个视图函数中的重复权限验证代码
- 消除了重复的文件路径验证代码
- 消除了重复的响应格式处理代码

#### 可维护性提升
- 统一的错误处理逻辑
- 统一的响应格式
- 集中的权限验证
- 更好的代码组织结构

### 5. 教师评价读取修复

#### 问题描述
用户反馈：点击教师评价按钮进行评价并保存后，再次点击教师评价按钮时，没有载入更新后的评价内容。

#### 问题分析
1. **格式不匹配**：`write_grade_and_comment_to_file`函数写入评价时使用格式`评价：{comment}`
2. **读取逻辑缺陷**：`get_teacher_comment`函数没有优先查找以"评价："开头的段落
3. **代码重复**：`get_teacher_comment`函数没有使用优化的装饰器和工具函数

#### 解决方案
1. **优化读取逻辑**：优先查找以"评价："开头的段落，提取冒号后的内容
2. **应用装饰器**：使用`@require_staff_user`和`@validate_file_operation`装饰器
3. **代码简化**：移除重复的权限验证和文件路径验证代码
4. **格式统一**：确保读写格式一致，支持多种评价格式

#### 修复效果
- **正确读取**：能够正确读取更新后的评价内容
- **格式兼容**：支持新旧评价格式的兼容性
- **代码优化**：函数代码行数减少约60%
- **功能完整**：所有测试用例通过验证

### 6. 评价内容清理优化

#### 问题描述
用户反馈：保存新评价后，再次点击教师评价按钮时，仍然读取到旧的评价内容（如`==================================================`），而不是新保存的内容。

#### 问题分析
1. **清理不彻底**：`write_grade_and_comment_to_file`函数只删除以特定前缀开头的段落
2. **格式识别不足**：无法识别像`==================================================`这样的分隔符或特殊格式的评价内容
3. **过滤逻辑简单**：只检查段落开头，没有检查段落内容

#### 解决方案
1. **增强删除逻辑**：
   ```python
   # 删除以评价关键词开头的段落
   if text.startswith(("教师评价：", "AI评价：", "评价：")):
       paragraphs_to_remove.append(i)
   # 删除包含评价关键词的段落
   elif any(keyword in text for keyword in ["评价", "评语", "AI评价", "教师评价"]):
       paragraphs_to_remove.append(i)
   # 删除看起来像分隔符的段落
   elif text.startswith("=") or text.startswith("-") or text.startswith("*"):
       paragraphs_to_remove.append(i)
   ```

2. **文本文件处理优化**：
   - 增强过滤逻辑，删除包含评价关键词的行
   - 删除看起来像分隔符的行
   - 确保新旧评价内容都被正确清理

#### 修复效果
- **彻底清理**：能够删除所有类型的旧评价内容
- **格式识别**：支持识别分隔符、特殊字符等评价格式
- **内容更新**：确保新评价内容正确写入和读取
- **兼容性强**：支持多种评价格式的清理和更新

### 7. 删除评分功能优化

#### 问题描述
用户反馈：点击撤销按钮（删除评分）时，系统显示"Word 文档中没有找到评分"，但实际上文件中确实有多个评分段落（如`老师评分：A`、`老师评分：N/A`、`老师评分：B`等）。

#### 问题分析
1. **删除逻辑局限**：`remove_grade`函数只检查最后一段是否是评分
2. **多评分处理不足**：无法处理文件中有多个评分段落的情况
3. **位置依赖**：假设评分总是在文档的最后位置
4. **文本文件同样问题**：文本文件的删除逻辑也存在类似问题

#### 解决方案
1. **Word文档删除优化**：
   ```python
   # 查找并删除所有评分段落
   paragraphs_to_remove = []
   for i, paragraph in enumerate(doc.paragraphs):
       text = paragraph.text.strip()
       if text.startswith(("老师评分：", "评定分数：")):
           paragraphs_to_remove.append(i)
           logger.info(f"找到评分段落 {i+1}: '{text}'")

   if paragraphs_to_remove:
       # 从后往前删除，避免索引变化
       for i in reversed(paragraphs_to_remove):
           doc._body._body.remove(doc.paragraphs[i]._p)
   ```

2. **文本文件删除优化**：
   ```python
   # 查找并删除所有评分行
   lines_to_keep = []
   removed_count = 0
   for i, line in enumerate(lines):
       line_text = line.strip()
       if line_text.startswith(("老师评分：", "评定分数：")):
           logger.info(f"找到评分行 {i+1}: '{line_text}'")
           removed_count += 1
       else:
           lines_to_keep.append(line)
   ```

#### 修复效果
- **全面删除**：能够删除文件中的所有评分段落，不限于最后一段
- **多评分支持**：正确处理文件中有多个评分的情况
- **位置无关**：不再依赖评分在文档中的位置
- **详细日志**：提供详细的删除操作日志，便于调试
- **计数反馈**：返回删除的评分数量，提供更好的用户反馈

## 弹出框功能实现

### 1. 模态框设计
- 创建了专门的AI评分提示模态框 (`aiScoreAlertModal`)
- 使用Bootstrap模态框组件，提供现代化的用户界面
- 模态框包含警告图标和清晰的信息展示

### 2. 内容展示
- **左侧文件内容预览**：显示文件的实际内容，帮助用户了解作业情况
- **右侧评分信息分析**：详细展示评分检测结果和文件分析信息
- **响应式布局**：在不同屏幕尺寸下都能良好显示

### 3. 信息展示
- **评分状态**：明确显示是否已发现评分
- **评分详情**：显示具体评分值、类型和位置
- **文件信息**：显示文件大小和内容预览
- **操作建议**：提供清晰的操作指导

### 4. 交互功能
- **智能检测**：自动检测Word文档表格和段落中的评分
- **内容限制**：对长文件内容进行截断，避免模态框过大
- **错误处理**：优雅处理文件读取和API调用错误
- **用户友好**：提供清晰的状态提示和操作反馈

### 5. 技术特点
- **异步加载**：文件内容和评分信息异步加载，提升用户体验
- **安全处理**：对HTML内容进行转义，防止XSS攻击
- **性能优化**：限制显示内容长度，避免性能问题
- **兼容性**：支持Word文档和文本文件格式
