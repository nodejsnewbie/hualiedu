{% extends 'base.html' %}
{% load static %}

{% block title %}ä½œä¸šæˆç»©å†™å…¥{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/themes/default/style.min.css' %}">
<style>
    #class-directory-tree {
        max-height: 420px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.75rem;
        background-color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">ğŸ“¥ ä½œä¸šæˆç»©å†™å…¥</h1>
            <p class="text-muted">
                é€‰æ‹©ä¸€ä¸ªç­çº§ç›®å½•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŸ¥æ‰¾å…¶ä¸­æ‰€æœ‰å½¢å¦‚ <code>ç¬¬Xæ¬¡ä½œä¸š.xlsx</code> çš„æ–‡ä»¶ï¼Œ
                å¹¶æ ¹æ®ä½œä¸šæ¬¡æ•°å†™å…¥ <code>æˆç»©ç™»åˆ†å†Œ.xlsx</code> çš„å¯¹åº”åˆ—ã€‚
            </p>
            <pre class="bg-light p-3 rounded small mb-0">
/è¯¾ç¨‹/23è®¡ç®—æœº5ç­/
â”œâ”€â”€ æˆç»©ç™»åˆ†å†Œ.xlsx
â”œâ”€â”€ ç¬¬ä¸€æ¬¡ä½œä¸š.xlsx
â”œâ”€â”€ ç¬¬äºŒæ¬¡ä½œä¸š.xlsx
â””â”€â”€ ç¬¬ä¸‰æ¬¡ä½œä¸š.xlsx
            </pre>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">é…ç½®å‚æ•°</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {% if repositories %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="repo-select" class="form-label">é€‰æ‹©ä»“åº“</label>
                            <select class="form-select" id="repo-select">
                                {% for repo in repositories %}
                                <option value="{{ repo.id }}" {% if repo.id == form_data.selected_repo_id %}selected{% endif %}>
                                    {{ repo.name }} ({{ repo.path }})
                                </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="selected-repo-id-input" name="selected_repo_id" value="{{ form_data.selected_repo_id }}">
                            <small class="form-text text-muted">åªå±•ç¤ºå½“å‰ç”¨æˆ·çš„æ´»è·ƒä»“åº“</small>
                        </div>
                        <div class="mb-3">
                            <label for="course-select" class="form-label">é€‰æ‹©è¯¾ç¨‹</label>
                            {% if courses %}
                            <select class="form-select" id="course-select">
                                {% for course in courses %}
                                <option value="{{ course }}" {% if course == form_data.selected_course %}selected{% endif %}>
                                    {{ course }}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="selected-course-input" name="selected_course" value="{{ form_data.selected_course }}">
                            <small class="form-text text-muted">è¯¾ç¨‹ç›®å½•ä½äºä»“åº“çš„é¦–å±‚</small>
                            {% else %}
                            <div class="alert alert-warning mb-0">è¯¥ä»“åº“ä¸‹æ²¡æœ‰è¯¾ç¨‹ç›®å½•</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å·²é€‰æ‹©çš„ç­çº§ç›®å½•</label>
                            <div class="form-control-plaintext border rounded py-2 px-2 bg-light" id="selected-class-path">
                                {% if form_data.class_directory_display %}
                                    {{ form_data.class_directory_display }}
                                {% else %}
                                    æœªé€‰æ‹©
                                {% endif %}
                            </div>
                            <input type="hidden" name="class_directory" id="class-directory-input" value="{{ form_data.class_directory }}">
                            <div class="form-text">è¯·é€‰æ‹©è¯¾ç¨‹ä¸‹çš„ç­çº§ï¼ˆå¦‚ 23è®¡ç®—æœº5ç­ï¼‰</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" {% if not courses %}disabled{% endif %}>
                            <i class="fas fa-upload me-2"></i> å¼€å§‹å†™å…¥
                        </button>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">è¯¾ç¨‹ç›®å½•</label>
                        <div id="class-directory-tree"
                             data-tree-url="{{ tree_api_url }}"
                             data-initial-class="{{ form_data.class_directory }}"></div>
                        <small class="form-text text-muted">
                            å±•å¼€è¯¾ç¨‹ç›®å½•åé€‰æ‹©ç­çº§ï¼›å³ä¾§åˆ—è¡¨ä»…æ˜¾ç¤ºç›®å½•ï¼Œæ–‡ä»¶å°†è‡ªåŠ¨å¤„ç†ã€‚
                        </small>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning mb-0">
                    å½“å‰è´¦å·æš‚æ— æ´»è·ƒä»“åº“ï¼Œæ— æ³•ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚è¯·å…ˆåœ¨ä»“åº“ç®¡ç†ä¸­åˆ›å»ºå¹¶æ¿€æ´»ä¸€ä¸ªä»“åº“ã€‚
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    {% if result %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">æ‰§è¡Œç»“æœ</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <p class="mb-1 text-muted">ä»“åº“</p>
                    <p class="h6 text-break">{{ result.repository_name }}</p>
                </div>
                <div class="col-md-3 mb-3">
                    <p class="mb-1 text-muted">è¯¾ç¨‹</p>
                    <p class="h6 text-break">{{ result.course_name }}</p>
                </div>
                <div class="col-md-3 mb-3">
                    <p class="mb-1 text-muted">ç­çº§ç›®å½•</p>
                    <p class="h6 text-break">{{ result.class_directory }}</p>
                </div>
                <div class="col-md-3 mb-3">
                    <p class="mb-1 text-muted">æˆç»©ç™»åˆ†å†Œ</p>
                    <p class="h6 text-break">{{ result.gradebook_file }}</p>
                </div>
                <div class="col-md-3 mb-3">
                    <p class="mb-1 text-muted">å¤„ç†æ¦‚è§ˆ</p>
                    <p class="h6">
                        å…±å‘ç° {{ result.total_files }} ä¸ªä½œä¸šæ–‡ä»¶ï¼Œ
                        æˆåŠŸ {{ result.success_count }} ä¸ªï¼Œ
                        å¤±è´¥ {{ result.error_count }} ä¸ª
                    </p>
                </div>
            </div>

            {% if result.processed %}
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶å</th>
                            <th>ä½œä¸šæ¬¡æ•°</th>
                            <th>å†™å…¥åˆ—</th>
                            <th>å·²æ›´æ–°å­¦ç”Ÿ</th>
                            <th>ç™»åˆ†å†Œç¼ºå¤±</th>
                            <th>ä½œä¸šç¼ºå¤±</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in result.processed %}
                        <tr>
                            <td class="text-break">{{ item.file_name }}</td>
                            <td>ç¬¬ {{ item.assignment_number }} æ¬¡</td>
                            <td>{{ item.assignment_column_letter }}</td>
                            <td>{{ item.updated_students }} äºº</td>
                            <td>{{ item.missing_in_gradebook|length }} äºº</td>
                            <td>{{ item.missing_in_assignment|length }} äºº</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            {% if result.errors %}
            <div class="mt-4">
                <h6>å†™å…¥å¤±è´¥çš„æ–‡ä»¶ï¼ˆ{{ result.errors|length }}ï¼‰</h6>
                <div class="list-group">
                    {% for item in result.errors %}
                    <div class="list-group-item list-group-item-warning">
                        <strong class="text-break">{{ item.file_name }}</strong>
                        <span class="ms-2 text-muted">ç¬¬ {{ item.assignment_number }} æ¬¡ä½œä¸š</span>
                        <div class="small text-danger mt-1">{{ item.error }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if repositories %}
{{ repositories|json_script:"toolbox-repos-data" }}
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const repoSelect = document.getElementById('repo-select');
        const repoInput = document.getElementById('selected-repo-id-input');
        const courseSelect = document.getElementById('course-select');
        const courseInput = document.getElementById('selected-course-input');
        const classInput = document.getElementById('class-directory-input');
        const classDisplay = document.getElementById('selected-class-path');
        const treeContainer = $('#class-directory-tree');
        const treeUrl = treeContainer.data('tree-url');
        const initialClassPath = treeContainer.data('initial-class') || '';
        const reposDataElement = document.getElementById('toolbox-repos-data');
        const reposData = reposDataElement ? JSON.parse(reposDataElement.textContent) : [];

        if (!repoSelect || !treeUrl) {
            return;
        }

        function getRepoData(repoId) {
            return reposData.find((repo) => repo.id === repoId);
        }

        function destroyTree() {
            if (treeContainer.data('jstree')) {
                treeContainer.jstree(true).destroy();
            } else {
                treeContainer.empty();
            }
        }

        function populateCourses(repoId, preset) {
            if (!courseSelect || !courseInput) {
                return;
            }
            const repo = getRepoData(repoId);
            const courseList = repo ? repo.courses : [];
            courseSelect.innerHTML = '';
            if (!courseList.length) {
                courseInput.value = '';
                classInput.value = '';
                classDisplay.textContent = 'æœªé€‰æ‹©';
                destroyTree();
                treeContainer.html('<div class="text-muted">è¯¥ä»“åº“æš‚æ— è¯¾ç¨‹ç›®å½•</div>');
                return;
            }

            courseList.forEach((course) => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseSelect.appendChild(option);
            });

            const targetCourse = preset && courseList.includes(preset) ? preset : courseList[0];
            courseSelect.value = targetCourse;
            courseInput.value = targetCourse;
        }

        function setSelectedPath(value) {
            classInput.value = value;
            if (!value) {
                classDisplay.textContent = 'æœªé€‰æ‹©';
            } else {
                const prefix = courseSelect && courseSelect.value ? courseSelect.value + '/' : '';
                classDisplay.textContent = prefix + value;
            }
        }

        function initializeTree(preselectPath) {
            const repoId = repoSelect.value;
            const courseName = courseSelect ? courseSelect.value : '';
            if (!repoId || !courseName) {
                destroyTree();
                treeContainer.html('<div class="text-muted">è¯·é€‰æ‹©æœ‰æ•ˆçš„ä»“åº“ä¸è¯¾ç¨‹</div>');
                return;
            }

            destroyTree();
            treeContainer
                .empty()
                .jstree({
                    core: {
                        data: function(node, cb) {
                            $.getJSON(treeUrl, {
                                repo_id: repoId,
                                course: courseName,
                                path: node.id === '#' ? '' : node.id
                            }).done(function(res) {
                                cb(res.children || []);
                            }).fail(function() {
                                cb([]);
                            });
                        },
                        themes: {
                            responsive: false
                        }
                    },
                    plugins: ['types'],
                    types: {
                        default: {
                            icon: 'bi bi-folder-fill text-secondary'
                        }
                    }
                })
                .on('select_node.jstree', function(e, data) {
                    const relPath = data.node.id || '';
                    setSelectedPath(relPath);
                })
                .on('ready.jstree', function(e, data) {
                    if (preselectPath) {
                        data.instance.select_node(preselectPath);
                        data.instance.open_node(preselectPath);
                    }
                });
        }

        repoSelect.addEventListener('change', function() {
            repoInput.value = this.value;
            populateCourses(this.value, '');
            setSelectedPath('');
            initializeTree('');
        });

        if (courseSelect) {
            courseSelect.addEventListener('change', function() {
                courseInput.value = this.value;
                setSelectedPath('');
                initializeTree('');
            });
        }

        populateCourses(repoSelect.value, courseInput ? courseInput.value : '');
        initializeTree(initialClassPath);
    });
</script>
{% endif %}
{% endblock %}
