{% extends 'base.html' %}
{% load static %}

{% block title %}创建作业配置{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
<style>
.form-container {
    max-width: 800px;
    margin: 0 auto;
}

.field-group {
    display: none;
}

.field-group.active {
    display: block;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

.form-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #495057;
}

.path-preview {
    font-family: 'Courier New', monospace;
    background: #e9ecef;
    padding: 10px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #495057;
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.alert-validation {
    display: none;
}

.storage-type-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.storage-type-option {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.storage-type-option:hover {
    border-color: #0d6efd;
    background: #f8f9fa;
}

.storage-type-option.selected {
    border-color: #0d6efd;
    background: #e7f1ff;
}

.storage-type-option input[type="radio"] {
    display: none;
}

.storage-type-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
    color: #6c757d;
}

.storage-type-option.selected .storage-type-icon {
    color: #0d6efd;
}

.storage-type-label {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 5px;
}

.storage-type-description {
    font-size: 0.875rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="form-container">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-plus-circle"></i> 创建作业配置</h2>
            <a href="{% url 'grading:assignment_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>

        <!-- 验证错误提示 -->
        <div class="alert alert-danger alert-validation" id="validationAlert" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span id="validationMessage"></span>
        </div>

        <!-- 表单 -->
        <form id="assignmentForm" method="post" novalidate>
            {% csrf_token %}

            <!-- 基本信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> 基本信息</h5>
                </div>
                <div class="card-body">
                    <!-- 作业名称 -->
                    <div class="mb-3">
                        <label for="assignmentName" class="form-label required-field">作业名称</label>
                        <input type="text" 
                               class="form-control" 
                               id="assignmentName" 
                               name="name" 
                               required
                               placeholder="例如：数据结构作业、算法设计作业">
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i> 请输入作业配置的名称，用于标识这个作业
                        </div>
                        <div class="invalid-feedback">
                            作业名称不能为空
                        </div>
                    </div>

                    <!-- 作业描述 -->
                    <div class="mb-3">
                        <label for="assignmentDescription" class="form-label">作业描述</label>
                        <textarea class="form-control" 
                                  id="assignmentDescription" 
                                  name="description"
                                  rows="3" 
                                  placeholder="作业配置描述（可选）"></textarea>
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i> 可选：添加关于这个作业配置的说明
                        </div>
                    </div>
                </div>
            </div>

            <!-- 课程和班级 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-book"></i> 课程和班级</h5>
                </div>
                <div class="card-body">
                    <!-- 课程选择 -->
                    <div class="mb-3">
                        <label for="assignmentCourse" class="form-label required-field">课程</label>
                        <select class="form-select" id="assignmentCourse" name="course_id" required>
                            <option value="">请选择课程</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i> 选择这个作业配置所属的课程
                        </div>
                        <div class="invalid-feedback">
                            请选择课程
                        </div>
                    </div>

                    <!-- 班级选择 -->
                    <div class="mb-3">
                        <label for="assignmentClass" class="form-label required-field">班级</label>
                        <select class="form-select" id="assignmentClass" name="class_id" required>
                            <option value="">请先选择课程</option>
                        </select>
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i> 选择这个作业配置所属的班级
                        </div>
                        <div class="invalid-feedback">
                            请选择班级
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交方式 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-upload"></i> 提交方式</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label required-field">选择学生提交作业的方式</label>
                        <div class="storage-type-selector">
                            <!-- 文件上传选项 -->
                            <div class="storage-type-option" data-type="filesystem">
                                <input type="radio" name="storage_type" value="filesystem" id="storageFilesystem" required>
                                <label for="storageFilesystem" class="w-100">
                                    <div class="storage-type-icon">
                                        <i class="bi bi-folder-fill"></i>
                                    </div>
                                    <div class="storage-type-label">文件上传</div>
                                    <div class="storage-type-description">
                                        学生通过网页上传作业文件
                                    </div>
                                </label>
                            </div>

                            <!-- Git仓库选项 -->
                            <div class="storage-type-option" data-type="git">
                                <input type="radio" name="storage_type" value="git" id="storageGit" required>
                                <label for="storageGit" class="w-100">
                                    <div class="storage-type-icon">
                                        <i class="bi bi-git"></i>
                                    </div>
                                    <div class="storage-type-label">Git仓库</div>
                                    <div class="storage-type-description">
                                        学生通过Git仓库提交作业
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="invalid-feedback d-block" id="storageTypeError" style="display: none !important;">
                            请选择提交方式
                        </div>
                    </div>

                    <!-- Git仓库配置字段 -->
                    <div id="gitFields" class="field-group">
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-git"></i> Git仓库配置
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                学生将通过Git仓库提交作业，系统将直接从远程仓库读取作业内容，无需本地同步
                            </div>
                            
                            <div class="mb-3">
                                <label for="gitUrl" class="form-label required-field">Git仓库URL</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="gitUrl" 
                                       name="git_url"
                                       placeholder="https://github.com/user/repo.git">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i> 支持 https、git、ssh 协议的Git仓库地址
                                </div>
                                <div class="invalid-feedback">
                                    请输入有效的Git仓库URL
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="gitBranch" class="form-label">分支名称</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="gitBranch" 
                                       name="git_branch"
                                       value="main" 
                                       placeholder="main">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i> 默认为 main 分支
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="gitUsername" class="form-label">Git用户名（可选）</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="gitUsername" 
                                       name="git_username"
                                       placeholder="用于私有仓库认证">
                                <div class="help-text">
                                    <i class="bi bi-info-circle"></i> 如果是私有仓库，请提供认证信息
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="gitPassword" class="form-label">Git密码/Token（可选）</label>
                                <input type="password" 
                                       class="form-control" 
                                       id="gitPassword" 
                                       name="git_password"
                                       placeholder="用于私有仓库认证">
                                <div class="help-text">
                                    <i class="bi bi-shield-lock"></i> 密码将被加密存储，请放心使用
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 文件上传配置字段 -->
                    <div id="filesystemFields" class="field-group">
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-folder"></i> 文件上传配置
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                学生将通过网页上传作业文件，系统将自动创建目录结构来组织作业
                            </div>
                            
                            <div class="alert alert-secondary">
                                <strong><i class="bi bi-folder-symlink"></i> 目录结构预览：</strong><br>
                                <div class="path-preview mt-2" id="pathPreview">
                                    请先选择课程和班级
                                </div>
                            </div>
                            
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i> 
                                系统将自动创建格式为 <code>&lt;课程名称&gt;/&lt;班级名称&gt;/&lt;作业次数&gt;/</code> 的目录结构
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div class="d-flex justify-content-end gap-2">
                <a href="{% url 'grading:assignment_list' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> 取消
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-check-circle"></i> 创建作业配置
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'grading/js/assignment-management.js' %}"></script>

<script>
$(document).ready(function() {
    // 提交方式选择器点击事件
    $('.storage-type-option').click(function() {
        const type = $(this).data('type');
        const radio = $(this).find('input[type="radio"]');
        
        // 更新选中状态
        $('.storage-type-option').removeClass('selected');
        $(this).addClass('selected');
        radio.prop('checked', true);
        
        // 显示对应的配置字段
        $('.field-group').removeClass('active');
        if (type === 'git') {
            $('#gitFields').addClass('active');
            $('#gitUrl').attr('required', true);
        } else if (type === 'filesystem') {
            $('#filesystemFields').addClass('active');
            $('#gitUrl').removeAttr('required');
            updatePathPreview();
        }
        
        // 清除提交方式错误提示
        $('#storageTypeError').hide();
    });
    
    // 课程选择变化时更新班级列表
    $('#assignmentCourse').change(function() {
        const courseId = $(this).val();
        const classSelect = $('#assignmentClass');
        
        // 清除验证状态
        $(this).removeClass('is-invalid');
        
        if (courseId) {
            classSelect.html('<option value="">加载中...</option>');
            classSelect.prop('disabled', true);
            
            $.ajax({
                url: '{% url "grading:get_course_classes" %}',
                method: 'GET',
                data: { course_id: courseId },
                success: function(response) {
                    if (response.status === 'success') {
                        classSelect.html('<option value="">请选择班级</option>');
                        response.classes.forEach(function(cls) {
                            classSelect.append(`<option value="${cls.id}">${cls.name}</option>`);
                        });
                        classSelect.prop('disabled', false);
                    } else {
                        classSelect.html('<option value="">加载失败，请重试</option>');
                        showValidationError('加载班级列表失败：' + response.message);
                    }
                },
                error: function() {
                    classSelect.html('<option value="">加载失败，请重试</option>');
                    showValidationError('加载班级列表失败，请检查网络连接');
                }
            });
        } else {
            classSelect.html('<option value="">请先选择课程</option>');
            classSelect.prop('disabled', true);
        }
        
        updatePathPreview();
    });
    
    // 班级选择变化时更新路径预览
    $('#assignmentClass').change(function() {
        // 清除验证状态
        $(this).removeClass('is-invalid');
        updatePathPreview();
    });
    
    // 更新路径预览
    function updatePathPreview() {
        const courseText = $('#assignmentCourse option:selected').text();
        const classText = $('#assignmentClass option:selected').text();
        
        if (courseText && classText && 
            courseText !== '请选择课程' && 
            classText !== '请选择班级' &&
            classText !== '请先选择课程' &&
            classText !== '加载中...' &&
            classText !== '加载失败，请重试') {
            $('#pathPreview').html(`<i class="bi bi-folder"></i> ${courseText}/${classText}/<span class="text-muted">&lt;作业次数&gt;/</span>`);
        } else {
            $('#pathPreview').text('请先选择课程和班级');
        }
    }
    
    // 显示验证错误
    function showValidationError(message) {
        $('#validationMessage').text(message);
        $('#validationAlert').fadeIn();
        
        // 滚动到顶部
        $('html, body').animate({
            scrollTop: $('#validationAlert').offset().top - 100
        }, 500);
        
        // 3秒后自动隐藏
        setTimeout(function() {
            $('#validationAlert').fadeOut();
        }, 5000);
    }
    
    // 表单提交
    $('#assignmentForm').submit(function(e) {
        e.preventDefault();
        
        // 清除之前的验证状态
        $('.is-invalid').removeClass('is-invalid');
        $('#validationAlert').hide();
        
        // 验证必填字段
        let isValid = true;
        let errorMessage = '';
        
        // 验证作业名称
        const name = $('#assignmentName').val().trim();
        if (!name) {
            $('#assignmentName').addClass('is-invalid');
            isValid = false;
            errorMessage = '请输入作业名称';
        }
        
        // 验证课程
        const courseId = $('#assignmentCourse').val();
        if (!courseId) {
            $('#assignmentCourse').addClass('is-invalid');
            isValid = false;
            errorMessage = errorMessage || '请选择课程';
        }
        
        // 验证班级
        const classId = $('#assignmentClass').val();
        if (!classId) {
            $('#assignmentClass').addClass('is-invalid');
            isValid = false;
            errorMessage = errorMessage || '请选择班级';
        }
        
        // 验证提交方式
        const storageType = $('input[name="storage_type"]:checked').val();
        if (!storageType) {
            $('#storageTypeError').show();
            isValid = false;
            errorMessage = errorMessage || '请选择提交方式';
        }
        
        // 如果选择Git方式，验证Git URL
        if (storageType === 'git') {
            const gitUrl = $('#gitUrl').val().trim();
            if (!gitUrl) {
                $('#gitUrl').addClass('is-invalid');
                isValid = false;
                errorMessage = errorMessage || '请输入Git仓库URL';
            } else if (!isValidUrl(gitUrl)) {
                $('#gitUrl').addClass('is-invalid');
                isValid = false;
                errorMessage = errorMessage || '请输入有效的Git仓库URL';
            }
        }
        
        if (!isValid) {
            showValidationError(errorMessage);
            return false;
        }
        
        // 禁用提交按钮，防止重复提交
        const submitBtn = $('#submitBtn');
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> 创建中...');
        
        // 提交表单
        const formData = new FormData(this);
        
        $.ajax({
            url: '{% url "grading:assignment_create" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    // 显示成功消息
                    alert('作业配置创建成功！');
                    // 跳转到列表页
                    window.location.href = '{% url "grading:assignment_list" %}';
                } else {
                    showValidationError(response.message || '创建失败，请重试');
                    submitBtn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> 创建作业配置');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showValidationError(response && response.message ? response.message : '请求失败，请检查网络连接');
                submitBtn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> 创建作业配置');
            }
        });
    });
    
    // URL验证函数
    function isValidUrl(url) {
        // 简单的URL格式验证
        const pattern = /^(https?|git|ssh):\/\/.+/i;
        return pattern.test(url);
    }
    
    // 输入框失去焦点时清除验证状态
    $('input, select, textarea').on('blur', function() {
        if ($(this).val()) {
            $(this).removeClass('is-invalid');
        }
    });
});
</script>
{% endblock %}
