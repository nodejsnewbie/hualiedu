{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="{% static 'grading/images/favicon.ico' %}">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<!-- jstree CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/themes/default/style.min.css' %}">
<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
<!-- CodeMirror -->
<link rel="stylesheet" href="{% static 'grading/vendor/codemirror/codemirror.min.css' %}">
<!-- Viewer.js -->
<link rel="stylesheet" href="{% static 'grading/vendor/viewerjs/viewer.min.css' %}">
<style>
    /* 优化的文件预览样式 */
    #file-content {
        min-height: 400px;
        max-height: 800px;
        overflow-y: auto;
        position: relative;
    }
    
    #file-content img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #file-content pre {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        max-height: 600px;
        overflow: auto;
    }
    
    /* 加载指示器优化 */
    #loading {
        background-color: rgba(255, 255, 255, 0.95);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* 文件预览提示 */
    #preview-hint {
        font-size: 0.9rem;
        padding: 0.75rem;
    }
    
    /* 优化目录树加载指示器 */
    #tree-loading {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧文件树 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-folder2-open"></i> 作业目录
                    </h5>
                    <div class="mt-2">
                        <button type="button" class="btn btn-success btn-sm me-2" id="batch-grade-btn" disabled title="请先选择作业文件夹（非文件）">
                            <i class="bi bi-tasks"></i> 批量登分
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="batch-ai-score-btn" disabled title="请先选择作业文件夹（非文件）">
                            <i class="bi bi-robot"></i> 批量AI评分
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 选择作业文件夹后可批量操作
                        </small>
                    </div>
                    <div id="batch-grade-progress-wrapper" class="mt-2" style="display: none;">
                        <div class="progress" role="progressbar" aria-label="批量登分进度" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <div id="batch-grade-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%;">
                                准备开始...
                            </div>
                        </div>
                        <div id="batch-grade-progress-text" class="text-muted small mt-1">
                            <i class="bi bi-hourglass-split"></i> 批量登分准备就绪
                        </div>
                    </div>
                    <!-- 加载指示器 -->
                    <div id="tree-loading" class="mt-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <span class="text-muted small">正在加载作业目录...</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="directory-tree"></div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="col-md-9">

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-text"></i> 文件内容
                    </h5>
                    <div class="file-count-display text-muted small">
                        <i class="bi bi-files"></i> <span id="directory-file-count">0</span> 个文件
                    </div>
                </div>
                <div class="card-body">
                    <!-- 增强的加载指示器 -->
                    <div id="loading" style="display: none;">
                        <div class="d-flex align-items-center justify-content-center py-5">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <div>
                                <h5 class="mb-1">正在加载文件...</h5>
                                <p class="text-muted mb-0 small" id="loading-message">请稍候</p>
                                <div class="progress mt-2" style="width: 300px; display: none;" id="loading-progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 优化的文件内容显示区域 -->
                    <div id="file-content" class="mt-3">
                        {% if error %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> {{ error }}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> 请从左侧选择要评分的文件
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 文件预览优化提示 -->
                    <div id="preview-hint" class="alert alert-secondary mt-2" style="display: none;">
                        <i class="bi bi-lightbulb"></i> 
                        <span id="preview-hint-text"></span>
                    </div>
                </div>
            </div>

            <!-- 评分区域 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">评分</h5>
                </div>
                <div class="card-body">
                    <!-- 文件导航按钮 -->
                    <div class="d-flex justify-content-between mb-3">
                        <button type="button" class="btn btn-outline-secondary" id="prev-file">
                            <i class="bi bi-arrow-left"></i> 上一个文件
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="next-file">
                            下一个文件 <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                    <!-- 评分按钮组 -->
                    <div class="d-flex align-items-center">
                        <!-- 评分方式切换 -->
                        <div class="btn-group me-3" role="group" aria-label="评分方式">
                            <button type="button" class="btn btn-outline-secondary grade-mode-btn active" data-mode="letter">
                                字母等级
                            </button>
                            <button type="button" class="btn btn-outline-secondary grade-mode-btn" data-mode="text">
                                文字等级
                            </button>
                            <button type="button" class="btn btn-outline-secondary grade-mode-btn" data-mode="percentage">
                                百分制
                            </button>
                        </div>



                        <!-- 字母等级按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="字母评分选项" id="letter-grade-buttons">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="A">A</button>
                            <button type="button" class="btn btn-outline-primary grade-button active" data-grade="B">B</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="C">C</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="D">D</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="E">E</button>
                        </div>

                        <!-- 文字等级按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="文字评分选项" id="text-grade-buttons" style="display: none;">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="优秀">优秀</button>
                            <button type="button" class="btn btn-outline-primary grade-button active" data-grade="良好">良好</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="中等">中等</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="及格">及格</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="不及格">不及格</button>
                        </div>

                        <!-- 百分制输入框 -->
                        <div class="input-group me-3" id="percentage-grade-input" style="display: none; width: 180px;">
                            <input type="number" class="form-control" id="percentage-input" min="0" max="100" step="0.5" value="85" placeholder="0-100" aria-label="百分制评分">
                            <span class="input-group-text">分</span>
                        </div>

                        <button type="button" class="btn btn-primary me-2" id="add-grade-to-file" disabled>
                            确定
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="cancel-grade">
                            撤销
                        </button>
                        <button type="button" class="btn btn-outline-info ms-2" id="teacher-comment-btn" disabled>
                            <i class="bi bi-chat-text"></i> 教师评价
                        </button>
                        <button type="button" class="btn btn-outline-success ms-2" id="ai-score-btn" disabled data-ai-grading-disabled="{{ grade_info.ai_grading_disabled }}">
                            <i class="bi bi-robot"></i> AI评分
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 教师评价模态框 -->
<div class="modal fade" id="teacherCommentModal" tabindex="-1" aria-labelledby="teacherCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherCommentModalLabel">教师评价</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 需求 5.2.3-5.2.9: 推荐评价模板 -->
                <div class="mb-3" id="commentTemplatesContainer" style="display: none;">
                    <label class="form-label">常用评价模板：</label>
                    <div id="commentTemplatesList" class="d-flex flex-wrap gap-2">
                        <!-- 模板按钮将通过JavaScript动态加载 -->
                    </div>
                    <small class="text-muted">点击模板可快速填充评价内容</small>
                </div>
                
                <div class="mb-3">
                    <label for="teacherCommentText" class="form-label">评价内容：</label>
                    <textarea class="form-control" id="teacherCommentText" rows="8" placeholder="请输入或修改教师评价内容..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeacherComment">保存评价</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>

<!-- 初始化数据 -->
<script>
    // 将初始数据传递给 JavaScript
    window.initialTreeData = {{ initial_tree_data|safe }};
    console.log('Initial tree data in template:', window.initialTreeData);

    // 设置 CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        }
    });
</script>

<!-- 评价缓存服务 - 需求 5.1.1-5.1.8 -->
<script src="{% static 'grading/js/comment-cache-service.js' %}"></script>

<!-- 自定义脚本 - 在jstree之前加载，确保评分功能优先 -->
<script src="{% static 'grading/js/grading.js' %}?v=20251113-2"></script>

<!-- 作业类型标签管理 -->
<script src="{% static 'grading/js/homework-type-labels.js' %}"></script>

<!-- jstree JavaScript -->
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>

<!-- CodeMirror -->
<script src="{% static 'grading/vendor/codemirror/codemirror.min.js' %}"></script>
<!-- Viewer.js -->
<script src="{% static 'grading/vendor/viewerjs/viewer.min.js' %}"></script>
<!-- PDF.js -->
<script src="{% static 'grading/vendor/pdfjs/pdf.min.js' %}"></script>

<script>
    // 设置 PDF.js worker 路径
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'grading/vendor/pdfjs/pdf.worker.min.js' %}";

    // 确保评分功能在页面完全加载后重新初始化
    $(document).ready(function() {
        console.log('=== 评分系统页面完全加载完成 ===');

        // 延迟重新初始化评分功能，确保其他库加载完成
        setTimeout(function() {
            console.log('重新初始化评分功能...');

            // 重新绑定评分方式切换按钮事件
            $(document).off('click', '.grade-mode-btn').on('click', '.grade-mode-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const mode = $(this).data('mode');
                console.log('=== 评分方式按钮被点击 ===');
                console.log('按钮模式:', mode);
                console.log('按钮元素:', this);
                console.log('按钮文本:', $(this).text());
                if (typeof switchGradeMode === 'function') {
                    switchGradeMode(mode);
                } else {
                    console.error('switchGradeMode函数未定义');
                }
            });

            // 重新绑定评分按钮点击事件
            $(document).off('click', '.grade-button').on('click', '.grade-button', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const grade = $(this).data('grade');
                console.log('Grade button clicked:', grade);
                if (typeof saveGrade === 'function') {
                    saveGrade(grade);
                } else {
                    console.error('saveGrade函数未定义');
                }
            });

            // 重新绑定确定按钮点击事件
            $(document).off('click', '#add-grade-to-file').on('click', '#add-grade-to-file', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Confirm button clicked, using selected grade:', selectedGrade);
                if (typeof addGradeToFile === 'function') {
                    addGradeToFile(selectedGrade);
                } else {
                    console.error('addGradeToFile函数未定义');
                }
            });

            // 重新绑定撤销按钮点击事件
            $(document).off('click', '#cancel-grade').on('click', '#cancel-grade', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof cancelGrade === 'function') {
                    cancelGrade();
                } else {
                    console.error('cancelGrade函数未定义');
                }
            });

            console.log('评分功能重新初始化完成');
        }, 1000);
    });
</script>
{% endblock %}
