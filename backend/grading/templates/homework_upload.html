{% extends 'base.html' %}
{% load static %}

{% block title %}作业上传{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .homework-list {
        margin-bottom: 30px;
    }
    
    .homework-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .homework-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .homework-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .homework-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .homework-type {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .homework-type.normal {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .homework-type.lab_report {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .homework-info {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .homework-info .info-item {
        margin-right: 20px;
        display: inline-block;
    }
    
    .upload-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }
    
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }
    
    .file-input-label {
        display: inline-block;
        padding: 8px 20px;
        background: #2196f3;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .file-input-label:hover {
        background: #1976d2;
    }
    
    .selected-file {
        color: #666;
        font-size: 14px;
    }
    
    .upload-btn {
        padding: 8px 24px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
    }
    
    .upload-btn:hover:not(:disabled) {
        background: #45a049;
    }
    
    .upload-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        display: none;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }
    
    .submission-history {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .submission-history h4 {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .submission-item {
        padding: 8px 12px;
        background: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .submission-item .version {
        font-weight: bold;
        color: #1976d2;
    }
    
    .submission-item .date {
        color: #999;
    }
    
    .alert {
        padding: 12px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h1>作业上传</h1>
    
    <div id="alert-container"></div>
    
    <div class="homework-list" id="homework-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 加载作业列表
    loadHomeworkList();
    
    function loadHomeworkList() {
        $.ajax({
            url: '{% url "grading:get_student_homework_list" %}',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    renderHomeworkList(response.homeworks);
                } else {
                    showAlert('error', response.message || '加载作业列表失败');
                }
            },
            error: function(xhr) {
                showAlert('error', '加载作业列表失败，请刷新页面重试');
            }
        });
    }
    
    function renderHomeworkList(homeworks) {
        const container = $('#homework-list');
        
        if (homeworks.length === 0) {
            container.html(`
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>暂无可上传的作业</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        homeworks.forEach(function(homework) {
            const typeClass = homework.homework_type === 'lab_report' ? 'lab_report' : 'normal';
            const typeText = homework.homework_type === 'lab_report' ? '实验报告' : '普通作业';
            const dueDate = homework.due_date ? new Date(homework.due_date).toLocaleString('zh-CN') : '无截止日期';
            const isOverdue = homework.is_overdue;
            const dueDateClass = isOverdue ? 'style="color: #f44336;"' : '';
            
            html += `
                <div class="homework-card" data-homework-id="${homework.id}">
                    <div class="homework-header">
                        <div class="homework-title">${homework.title}</div>
                        <span class="homework-type ${typeClass}">${typeText}</span>
                    </div>
                    <div class="homework-info">
                        <span class="info-item"><i class="fas fa-book"></i> ${homework.course_name}</span>
                        <span class="info-item"><i class="fas fa-users"></i> ${homework.class_name}</span>
                        <span class="info-item" ${dueDateClass}><i class="fas fa-clock"></i> ${dueDate}</span>
                    </div>
                    ${homework.description ? `<div class="homework-info">${homework.description}</div>` : ''}
                    
                    <div class="upload-section">
                        <div class="file-input-wrapper">
                            <input type="file" id="file-${homework.id}" class="file-input" 
                                   accept=".docx,.doc,.txt,.pdf,.xlsx,.xls,.zip,.rar">
                            <label for="file-${homework.id}" class="file-input-label">
                                <i class="fas fa-folder-open"></i> 选择文件
                            </label>
                        </div>
                        <span class="selected-file" id="selected-file-${homework.id}">未选择文件</span>
                        <button class="upload-btn" onclick="uploadFile(${homework.id})" id="upload-btn-${homework.id}" disabled>
                            <i class="fas fa-upload"></i> 上传
                        </button>
                    </div>
                    
                    <div class="progress-bar" id="progress-${homework.id}">
                        <div class="progress-fill" id="progress-fill-${homework.id}">0%</div>
                    </div>
                    
                    ${renderSubmissionHistory(homework.submissions)}
                </div>
            `;
        });
        
        container.html(html);
        
        // 绑定文件选择事件
        $('.file-input').on('change', function() {
            const homeworkId = $(this).attr('id').replace('file-', '');
            const fileName = this.files[0] ? this.files[0].name : '未选择文件';
            $(`#selected-file-${homeworkId}`).text(fileName);
            $(`#upload-btn-${homeworkId}`).prop('disabled', !this.files[0]);
        });
    }
    
    function renderSubmissionHistory(submissions) {
        if (!submissions || submissions.length === 0) {
            return '';
        }
        
        let html = '<div class="submission-history"><h4>提交历史</h4>';
        submissions.forEach(function(submission) {
            const date = new Date(submission.submitted_at).toLocaleString('zh-CN');
            const size = formatFileSize(submission.file_size);
            const gradeInfo = submission.grade ? ` - 评分: ${submission.grade}` : '';
            
            html += `
                <div class="submission-item">
                    <div>
                        <span class="version">版本 ${submission.version}</span>
                        <span> - ${submission.file_name} (${size})${gradeInfo}</span>
                    </div>
                    <span class="date">${date}</span>
                </div>
            `;
        });
        html += '</div>';
        return html;
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    window.uploadFile = function(homeworkId) {
        const fileInput = $(`#file-${homeworkId}`)[0];
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('error', '请选择要上传的文件');
            return;
        }
        
        // 禁用上传按钮
        $(`#upload-btn-${homeworkId}`).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 上传中...');
        
        // 显示进度条
        $(`#progress-${homeworkId}`).show();
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('homework_id', homeworkId);
        
        $.ajax({
            url: '{% url "grading:upload_homework" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        $(`#progress-fill-${homeworkId}`).css('width', percentComplete + '%').text(percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message || '上传成功！');
                    // 重新加载作业列表以显示新的提交记录
                    setTimeout(function() {
                        loadHomeworkList();
                    }, 1000);
                } else {
                    showAlert('error', response.message || '上传失败');
                    $(`#upload-btn-${homeworkId}`).prop('disabled', false).html('<i class="fas fa-upload"></i> 上传');
                }
            },
            error: function(xhr) {
                let errorMsg = '上传失败，请重试';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                showAlert('error', errorMsg);
                $(`#upload-btn-${homeworkId}`).prop('disabled', false).html('<i class="fas fa-upload"></i> 上传');
            },
            complete: function() {
                // 隐藏进度条
                setTimeout(function() {
                    $(`#progress-${homeworkId}`).hide();
                    $(`#progress-fill-${homeworkId}`).css('width', '0%').text('0%');
                }, 2000);
            }
        });
    };
    
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : (type === 'error' ? 'alert-error' : 'alert-info');
        const alert = $(`
            <div class="alert ${alertClass}">
                ${message}
            </div>
        `);
        
        $('#alert-container').html(alert);
        
        // 3秒后自动消失
        setTimeout(function() {
            alert.fadeOut(function() {
                $(this).remove();
            });
        }, 3000);
    }
});
</script>
{% endblock %}
