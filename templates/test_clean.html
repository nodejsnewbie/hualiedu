<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Test Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Clean Test Page</h1>
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <select id="repositorySelect" class="form-select">
                            <option value="">选择仓库...</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="directory-tree">
                            <p class="text-muted">请先选择仓库</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>文件内容</h3>
                    </div>
                    <div class="card-body">
                        <div id="fileContent">
                            <p class="text-muted">请选择文件</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    $(document).ready(function() {
        console.log('Clean page loaded');
        
        // 设置 CSRF token
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                }
            }
        });

        // 加载仓库列表
        loadRepositoryList();

        // 仓库选择事件
        $('#repositorySelect').change(function() {
            const selectedRepo = $(this).val();
            if (selectedRepo) {
                loadRepositoryFiles(selectedRepo);
            } else {
                $('#directory-tree').html('<p class="text-muted">请先选择仓库</p>');
            }
        });
    });

    function loadRepositoryList() {
        $.ajax({
            url: '/grading/api/repositories/',
            method: 'GET',
            success: function(response) {
                console.log('Repository response:', response);
                if (response.status === 'success') {
                    const select = $('#repositorySelect');
                    select.empty().append('<option value="">选择仓库...</option>');

                    response.repositories.forEach(function(repo) {
                        select.append('<option value="' + repo.id + '">' + repo.name + '</option>');
                    });
                }
            },
            error: function(xhr) {
                console.error('Failed to load repositories');
            }
        });
    }

    function loadRepositoryFiles(repositoryId) {
        $('#directory-tree').html('<p class="text-muted">正在加载...</p>');
        
        $.ajax({
            url: '/grading/get_directory_tree/',
            method: 'GET',
            data: {
                repo_id: repositoryId
            },
            success: function(response) {
                console.log('Directory response:', response);
                if (response && response.children && response.children.length > 0) {
                    renderDirectoryTree(response.children);
                } else {
                    $('#directory-tree').html('<p class="text-warning">该仓库暂无文件</p>');
                }
            },
            error: function(xhr) {
                $('#directory-tree').html('<p class="text-danger">加载失败</p>');
            }
        });
    }

    function renderDirectoryTree(files) {
        const container = $('#directory-tree');
        container.empty();
        
        const list = $('<ul class="list-group"></ul>');
        
        files.forEach(function(file) {
            const isDir = file.type === 'folder';
            const item = $('<li class="list-group-item">' + (file.text || file.name) + '</li>');
            
            if (!isDir) {
                item.addClass('text-primary').css('cursor', 'pointer');
                item.click(function() {
                    $('#fileContent').html('<p>选中文件: ' + file.text + '</p>');
                });
            }
            
            list.append(item);
        });
        
        container.append(list);
    }
    </script>
</body>
</html>