{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/themes/default/style.min.css' %}">
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧仓库选择和文件目录 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-sm-8">
                            <select id="repositorySelect" class="form-select">
                                <option value="">选择仓库...</option>
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <a href="{% url 'grading:repository_management' %}" class="btn btn-sm btn-secondary">管理仓库</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button id="batchGradeBtn" class="btn btn-sm btn-primary me-2">批量登分</button>
                        <button id="batchAiGradeBtn" class="btn btn-sm btn-info">批量AI评分</button>
                    </div>
                    <!-- 文件目录树容器 -->
                    <div id="directory-tree" class="overflow-auto" style="max-height: 600px;">
                        <p class="text-muted">请先选择仓库</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧内容区 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 id="fileNameHeader">选择文件</h3>
                    <div class="file-count-display text-muted small">
                        文件: <span id="current-file-index">0</span>/<span id="total-files">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 评分按钮组 -->
                    <div class="mb-3">
                        <div class="btn-group me-3" role="group" aria-label="评分方式选择">
                            <button type="button" class="btn btn-outline-secondary grade-mode-button active" data-mode="letter">字母评分</button>
                            <button type="button" class="btn btn-outline-secondary grade-mode-button" data-mode="text">文字评分</button>
                        </div>
                        
                        <!-- 字母评分按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="字母评分选项" id="letter-grade-buttons">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="A">A</button>
                            <button type="button" class="btn btn-outline-primary grade-button active" data-grade="B">B</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="C">C</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="D">D</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="E">E</button>
                        </div>
                        
                        <!-- 文字评分按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="文字评分选项" id="text-grade-buttons" style="display: none;">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="优秀">优秀</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="良好">良好</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="中等">中等</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="及格">及格</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="不及格">不及格</button>
                        </div>
                        
                        <button id="saveGradeBtn" class="btn btn-success me-2">保存评分</button>
                        <button id="teacherCommentBtn" class="btn btn-warning me-2" disabled>教师评价</button>
                        <button id="aiScoreBtn" class="btn btn-info">AI评分</button>
                    </div>
                    
                    <!-- 导航按钮 -->
                    <div class="mb-3">
                        <button id="prev-file" class="btn btn-outline-secondary me-2" disabled>
                            <i class="bi bi-arrow-left"></i> 上一个文件
                        </button>
                        <button id="next-file" class="btn btn-outline-secondary" disabled>
                            下一个文件 <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                    
                    <!-- 文件内容显示区域 -->
                    <div id="fileContentArea" class="border rounded p-3" style="min-height: 400px; background-color: #f8f9fa;">
                        <p class="text-muted text-center">请选择文件查看内容</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 教师评价模态框 -->
<div class="modal fade" id="teacherCommentModal" tabindex="-1" aria-labelledby="teacherCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherCommentModalLabel">教师评价</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="teacherCommentText" class="form-label">评价内容</label>
                    <textarea class="form-control" id="teacherCommentText" rows="5" placeholder="请输入教师评价..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeacherCommentBtn">保存评价</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>
<!-- 暂时不加载grading.js，避免冲突 -->
<!-- <script src="{% static 'grading/js/grading.js' %}"></script> -->

<script>
// 全局变量
var currentFilePath = null;
var currentGrade = 'B';
var currentGradeMode = 'letter';
var fileNodes = [];
var currentFileIndex = -1;

$(document).ready(function() {
    console.log('评分页面初始化');
    
    // 设置初始树数据为空，避免grading.js报错
    window.initialTreeData = [];
    
    // 设置CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        }
    });

    // 初始化事件监听器
    initEventListeners();
    
    // 加载仓库列表
    loadRepositoryList();
});

function initEventListeners() {
    // 仓库选择事件
    $('#repositorySelect').change(function() {
        var selectedRepo = $(this).val();
        if (selectedRepo) {
            loadRepositoryFiles(selectedRepo);
        } else {
            $('#directory-tree').html('<p class="text-muted">请先选择仓库</p>');
        }
    });
    
    // 评分方式切换
    $(document).on('click', '.grade-mode-button', function() {
        var mode = $(this).data('mode');
        switchGradeMode(mode);
    });
    
    // 评分按钮点击
    $(document).on('click', '.grade-button', function() {
        var grade = $(this).data('grade');
        setCurrentGrade(grade);
    });
    
    // 保存评分
    $('#saveGradeBtn').click(function() {
        saveCurrentGrade();
    });
    
    // 教师评价
    $('#teacherCommentBtn').click(function() {
        showTeacherCommentModal();
    });
    
    // 保存教师评价
    $('#saveTeacherCommentBtn').click(function() {
        saveTeacherComment();
    });
    
    // AI评分
    $('#aiScoreBtn').click(function() {
        performAIScore();
    });
    
    // 文件导航
    $('#prev-file').click(function() {
        navigateToFile(currentFileIndex - 1);
    });
    
    $('#next-file').click(function() {
        navigateToFile(currentFileIndex + 1);
    });
    
    // 批量功能
    $('#batchGradeBtn').click(function() {
        window.open('/grading/batch-grade/', '_blank');
    });
    
    $('#batchAiGradeBtn').click(function() {
        window.open('/grading/batch-ai-score/', '_blank');
    });
}

function loadRepositoryList() {
    $.ajax({
        url: '/grading/api/repositories/',
        method: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                var select = $('#repositorySelect');
                select.empty().append('<option value="">选择仓库...</option>');

                response.repositories.forEach(function(repo) {
                    select.append('<option value="' + repo.id + '">' + repo.name + '</option>');
                });
                
                // 如果只有一个仓库，自动选择
                if (response.repositories.length === 1) {
                    select.val(response.repositories[0].id).trigger('change');
                }
            }
        },
        error: function(xhr) {
            console.error('加载仓库列表失败');
        }
    });
}

function loadRepositoryFiles(repositoryId) {
    $('#directory-tree').html('<p class="text-muted">正在加载文件...</p>');
    
    $.ajax({
        url: '/grading/get_directory_tree/',
        method: 'GET',
        data: {
            repo_id: repositoryId
        },
        success: function(response) {
            console.log('目录树响应:', response);
            if (response && response.children && response.children.length > 0) {
                // 使用JSTree渲染
                if (typeof window.initTree === 'function') {
                    window.initTree(response.children);
                } else {
                    renderDirectoryTree(response.children);
                }
                
                // 收集所有文件节点
                collectFileNodes(response.children);
                updateFileCount();
            } else {
                $('#directory-tree').html('<p class="text-warning">该仓库暂无文件</p>');
            }
        },
        error: function(xhr) {
            $('#directory-tree').html('<p class="text-danger">加载文件失败</p>');
        }
    });
}

function renderDirectoryTree(files) {
    var container = $('#directory-tree');
    container.empty();
    
    var list = $('<ul class="list-group"></ul>');
    
    function renderNode(node, level) {
        var isDir = node.type === 'folder';
        var hasChildren = node.children && node.children.length > 0;
        var indent = 'padding-left: ' + (level * 20 + (isDir && hasChildren ? 0 : 20)) + 'px;';
        
        // 为文件夹创建展开/收起图标
        var expandIcon = '';
        if (isDir && hasChildren) {
            expandIcon = '<i class="bi bi-chevron-down expand-icon me-1" style="cursor: pointer; transition: transform 0.2s;"></i>';
        }
        
        var fileIcon = isDir ? 'bi-folder' : 'bi-file-text';
        
        var item = $('<li class="list-group-item d-flex align-items-center" style="' + indent + '">' +
            expandIcon +
            '<i class="bi ' + fileIcon + ' me-2"></i>' + 
            '<span class="node-text">' + (node.text || node.name) + '</span>' +
            '</li>');
        
        // 为子节点创建容器
        var childrenContainer = null;
        if (isDir && hasChildren) {
            childrenContainer = $('<div class="children-container"></div>');
            
            // 添加展开/收起功能
            item.find('.expand-icon, .node-text').css('cursor', 'pointer').click(function(e) {
                e.stopPropagation();
                var icon = item.find('.expand-icon');
                var isExpanded = !childrenContainer.is(':hidden');
                
                if (isExpanded) {
                    // 收起
                    childrenContainer.slideUp(200);
                    icon.css('transform', 'rotate(-90deg)');
                } else {
                    // 展开
                    childrenContainer.slideDown(200);
                    icon.css('transform', 'rotate(0deg)');
                }
            });
            
            // 默认展开第一级目录
            if (level === 0) {
                childrenContainer.show();
            } else {
                childrenContainer.hide();
                item.find('.expand-icon').css('transform', 'rotate(-90deg)');
            }
        }
        
        if (!isDir) {
            item.find('.node-text').addClass('text-primary file-item').css('cursor', 'pointer');
            item.data('file-path', node.id);
            
            item.find('.node-text').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                loadFileContent(node.id);
            });
        }
        
        list.append(item);
        
        // 渲染子节点
        if (isDir && hasChildren) {
            var childList = $('<ul class="list-group border-0"></ul>');
            node.children.forEach(function(child) {
                renderChildNode(child, level + 1, childList);
            });
            childrenContainer.append(childList);
            list.append(childrenContainer);
        }
    }
    
    function renderChildNode(node, level, parentList) {
        var isDir = node.type === 'folder';
        var hasChildren = node.children && node.children.length > 0;
        var indent = 'padding-left: ' + (level * 20 + (isDir && hasChildren ? 0 : 20)) + 'px;';
        
        // 为文件夹创建展开/收起图标
        var expandIcon = '';
        if (isDir && hasChildren) {
            expandIcon = '<i class="bi bi-chevron-down expand-icon me-1" style="cursor: pointer; transition: transform 0.2s; transform: rotate(-90deg);"></i>';
        }
        
        var fileIcon = isDir ? 'bi-folder' : 'bi-file-text';
        
        var item = $('<li class="list-group-item d-flex align-items-center border-0" style="' + indent + '">' +
            expandIcon +
            '<i class="bi ' + fileIcon + ' me-2"></i>' + 
            '<span class="node-text">' + (node.text || node.name) + '</span>' +
            '</li>');
        
        // 为子节点创建容器
        var childrenContainer = null;
        if (isDir && hasChildren) {
            childrenContainer = $('<div class="children-container" style="display: none;"></div>');
            
            // 添加展开/收起功能
            item.find('.expand-icon, .node-text').css('cursor', 'pointer').click(function(e) {
                e.stopPropagation();
                var icon = item.find('.expand-icon');
                var isExpanded = !childrenContainer.is(':hidden');
                
                if (isExpanded) {
                    // 收起
                    childrenContainer.slideUp(200);
                    icon.css('transform', 'rotate(-90deg)');
                } else {
                    // 展开
                    childrenContainer.slideDown(200);
                    icon.css('transform', 'rotate(0deg)');
                }
            });
        }
        
        if (!isDir) {
            item.find('.node-text').addClass('text-primary file-item').css('cursor', 'pointer');
            item.data('file-path', node.id);
            
            item.find('.node-text').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                loadFileContent(node.id);
            });
        }
        
        parentList.append(item);
        
        // 渲染子节点
        if (isDir && hasChildren) {
            var childList = $('<ul class="list-group border-0"></ul>');
            node.children.forEach(function(child) {
                renderChildNode(child, level + 1, childList);
            });
            childrenContainer.append(childList);
            parentList.append(childrenContainer);
        }
    }
    
    files.forEach(function(file) {
        renderNode(file, 0);
    });
    
    container.append(list);
}

function collectFileNodes(nodes) {
    fileNodes = [];
    
    function traverse(node) {
        if (node.type !== 'folder') {
            fileNodes.push(node);
        }
        if (node.children) {
            node.children.forEach(traverse);
        }
    }
    
    nodes.forEach(traverse);
}

function loadFileContent(filePath) {
    currentFilePath = filePath;
    currentFileIndex = fileNodes.findIndex(function(node) {
        return node.id === filePath;
    });
    
    var fileName = filePath.split('/').pop();
    $('#fileNameHeader').text('正在加载: ' + fileName);
    $('#fileContentArea').html('<p class="text-muted">正在加载文件内容...</p>');
    
    // 启用教师评价按钮
    $('#teacherCommentBtn').prop('disabled', false);
    
    // 更新导航按钮
    updateNavigationButtons();
    
    // 更新文件计数显示
    updateFileCount();
    
    console.log('Loading file content for:', filePath);
    
    // 使用当前选择的仓库ID和文件路径
    var repositoryId = $('#repositorySelect').val();
    
    // 加载文件内容 - 使用仓库特定的API
    $.ajax({
        url: '/grading/get_file_content/',
        method: 'POST',
        data: {
            path: filePath,
            repo_id: repositoryId
        },
        success: function(response) {
            console.log('File content response:', response);
            if (response.status === 'success') {
                $('#fileNameHeader').text(fileName);
                
                if (response.type === 'image') {
                    $('#fileContentArea').html('<img src="' + response.content + '" class="img-fluid" alt="' + fileName + '">');
                } else if (response.type === 'docx') {
                    $('#fileContentArea').html(response.content);
                } else {
                    $('#fileContentArea').html('<pre class="bg-white p-3 border rounded">' + response.content + '</pre>');
                }
                
                // 加载现有评分
                loadExistingGrade(filePath);
            } else {
                $('#fileContentArea').html('<p class="text-danger">加载失败: ' + response.message + '</p>');
            }
        },
        error: function(xhr) {
            console.error('File content load error:', xhr);
            $('#fileContentArea').html('<p class="text-danger">加载文件失败</p>');
        }
    });
}

function switchGradeMode(mode) {
    currentGradeMode = mode;
    
    $('.grade-mode-button').removeClass('active');
    $('.grade-mode-button[data-mode="' + mode + '"]').addClass('active');
    
    if (mode === 'letter') {
        $('#letter-grade-buttons').show();
        $('#text-grade-buttons').hide();
    } else {
        $('#letter-grade-buttons').hide();
        $('#text-grade-buttons').show();
    }
}

function setCurrentGrade(grade) {
    currentGrade = grade;
    
    // 更新按钮状态
    $('.grade-button').removeClass('active');
    $('.grade-button[data-grade="' + grade + '"]').addClass('active');
}

function saveCurrentGrade() {
    if (!currentFilePath) {
        alert('请先选择文件');
        return;
    }
    
    $.ajax({
        url: '/grading/save_grade/',
        method: 'POST',
        data: {
            path: currentFilePath,
            grade: currentGrade,
            grade_type: currentGradeMode
        },
        success: function(response) {
            if (response.status === 'success') {
                alert('评分保存成功');
                // 自动跳转到下一个文件
                if (currentFileIndex < fileNodes.length - 1) {
                    navigateToFile(currentFileIndex + 1);
                }
            } else {
                alert('保存失败: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('保存评分失败');
        }
    });
}

function loadExistingGrade(filePath) {
    console.log('Loading existing grade for:', filePath);
    
    var repositoryId = $('#repositorySelect').val();
    if (!repositoryId) {
        console.log('No repository selected, skipping grade loading');
        return;
    }
    
    $.ajax({
        url: '/grading/get_file_grade_info/',
        method: 'POST',
        data: {
            path: filePath,
            repo_id: repositoryId
        },
        success: function(response) {
            console.log('Grade info response:', response);
            if (response.has_grade) {
                setCurrentGrade(response.grade);
                if (response.grade_type) {
                    switchGradeMode(response.grade_type);
                }
            }
        },
        error: function(xhr) {
            console.log('获取评分信息失败:', xhr.status, xhr.statusText);
        }
    });
}

function showTeacherCommentModal() {
    if (!currentFilePath) {
        alert('请先选择文件');
        return;
    }
    
    // 加载现有评价
    $.ajax({
        url: '/grading/get_teacher_comment/',
        method: 'GET',
        data: {
            path: currentFilePath
        },
        success: function(response) {
            $('#teacherCommentText').val(response.comment || '');
            $('#teacherCommentModal').modal('show');
        },
        error: function(xhr) {
            $('#teacherCommentText').val('');
            $('#teacherCommentModal').modal('show');
        }
    });
}

function saveTeacherComment() {
    var comment = $('#teacherCommentText').val();
    
    $.ajax({
        url: '/grading/save_teacher_comment/',
        method: 'POST',
        data: {
            path: currentFilePath,
            comment: comment
        },
        success: function(response) {
            if (response.status === 'success') {
                alert('教师评价保存成功');
                $('#teacherCommentModal').modal('hide');
            } else {
                alert('保存失败: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('保存教师评价失败');
        }
    });
}

function performAIScore() {
    if (!currentFilePath) {
        alert('请先选择文件');
        return;
    }
    
    var repositoryId = $('#repositorySelect').val();
    if (!repositoryId) {
        alert('请先选择仓库');
        return;
    }
    
    $('#aiScoreBtn').prop('disabled', true).text('AI评分中...');
    
    $.ajax({
        url: '/grading/ai_score/',
        method: 'POST',
        data: {
            path: currentFilePath,
            repo_id: repositoryId
        },
        success: function(response) {
            if (response.status === 'success') {
                setCurrentGrade(response.grade);
                alert('AI评分完成: ' + response.grade);
            } else {
                alert('AI评分失败: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('AI评分失败');
        },
        complete: function() {
            $('#aiScoreBtn').prop('disabled', false).text('AI评分');
        }
    });
}

function navigateToFile(index) {
    if (index >= 0 && index < fileNodes.length) {
        var fileNode = fileNodes[index];
        loadFileContent(fileNode.id);
    }
}

function updateNavigationButtons() {
    $('#prev-file').prop('disabled', currentFileIndex <= 0);
    $('#next-file').prop('disabled', currentFileIndex >= fileNodes.length - 1);
}

function updateFileCount() {
    $('#current-file-index').text(currentFileIndex + 1);
    $('#total-files').text(fileNodes.length);
}

// 为grading.js提供兼容性函数
window.loadFile = function(filePath) {
    loadFileContent(filePath);
};

window.initTree = function(treeData) {
    console.log('initTree called with data:', treeData);
    if (treeData && treeData.length > 0) {
        renderDirectoryTree(treeData);
        collectFileNodes(treeData);
        updateFileCount();
    }
};
</script>
{% endblock %}