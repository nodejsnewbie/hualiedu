{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="{% static 'grading/images/favicon.ico' %}">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<!-- JSTree CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/themes/default/style.min.css' %}">
<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧仓库选择和文件目录 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-sm-8">
                            <select id="repositorySelect" class="form-select">
                                <option value="">选择仓库...</option>
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <a href="{% url 'grading:repository_management' %}" class="btn btn-sm btn-secondary">管理仓库</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button id="batchGradeBtn" class="btn btn-sm btn-primary me-2">批量登分</button>
                        <button id="batchAiGradeBtn" class="btn btn-sm btn-info">批量AI评分</button>
                    </div>
                    <!-- 文件目录树容器 -->
                    <div id="directory-tree" class="overflow-auto" style="max-height: 600px;">
                        <p class="text-muted">请先选择仓库</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧内容区 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 id="fileNameHeader">选择文件</h3>
                    <div class="file-count-display text-muted small">
                        文件: <span id="current-file-index">0</span>/<span id="total-files">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 评分按钮组 -->
                    <div class="mb-3">
                        <div class="btn-group me-3" role="group" aria-label="评分方式选择">
                            <button type="button" class="btn btn-outline-secondary grade-mode-button active" data-mode="letter">字母评分</button>
                            <button type="button" class="btn btn-outline-secondary grade-mode-button" data-mode="text">文字评分</button>
                        </div>
                        
                        <!-- 字母评分按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="字母评分选项" id="letter-grade-buttons">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="A">A</button>
                            <button type="button" class="btn btn-outline-primary grade-button active" data-grade="B">B</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="C">C</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="D">D</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="E">E</button>
                        </div>
                        
                        <!-- 文字评分按钮组 -->
                        <div class="btn-group me-3" role="group" aria-label="文字评分选项" id="text-grade-buttons" style="display: none;">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="优秀">优秀</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="良好">良好</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="中等">中等</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="及格">及格</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="不及格">不及格</button>
                        </div>
                        
                        <button id="saveGradeBtn" class="btn btn-success me-2">保存评分</button>
                        <button id="teacherCommentBtn" class="btn btn-warning me-2" disabled>教师评价</button>
                        <button id="aiScoreBtn" class="btn btn-info">AI评分</button>
                    </div>
                    
                    <!-- 文件内容显示区域 -->
                    <div id="fileContentArea" class="border rounded p-3" style="min-height: 400px; background-color: #f8f9fa;">
                        <p class="text-muted text-center">请选择文件查看内容</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 教师评价模态框 -->
<div class="modal fade" id="teacherCommentModal" tabindex="-1" aria-labelledby="teacherCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherCommentModalLabel">教师评价</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="teacherCommentText" class="form-label">评价内容</label>
                    <textarea class="form-control" id="teacherCommentText" rows="5" placeholder="请输入教师评价..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeacherCommentBtn">保存评价</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 确保jQuery先加载 -->
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<!-- JSTree JS -->
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>
<!-- 自定义脚本 -->
<script src="{% static 'grading/js/grading.js' %}"></script>

<script>
$(document).ready(function() {
    console.log('页面初始化开始');
    
    // 设置 CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        }
    });

    // 加载用户仓库列表
    loadRepositoryList();

    // 仓库选择变化事件
    $('#repositorySelect').change(function() {
        const selectedRepo = $(this).val();
        if (selectedRepo) {
            loadRepositoryFiles(selectedRepo);
        } else {
            $('#directory-tree').html('<p class="text-muted">请先选择仓库</p>');
        }
    });
});

// 加载仓库列表
function loadRepositoryList() {
    $.ajax({
        url: '{% url "grading:get_repository_list_api" %}',
        method: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                const select = $('#repositorySelect');
                select.empty().append('<option value="">选择仓库...</option>');

                response.repositories.forEach(function(repo) {
                    select.append('<option value="' + repo.id + '">' + repo.name + ' (' + (repo.type === 'git' ? 'Git' : '本地') + ')</option>');
                });

                // 如果只有一个仓库，自动选择
                if (response.repositories.length === 1) {
                    select.val(response.repositories[0].id).trigger('change');
                }
            } else {
                console.error('加载仓库列表失败:', response.message);
            }
        },
        error: function(xhr) {
            console.error('加载仓库列表失败');
        }
    });
}

// 加载仓库文件
function loadRepositoryFiles(repositoryId) {
    $('#directory-tree').html('<p class="text-muted">正在加载文件...</p>');
    
    $.ajax({
        url: '{% url "grading:get_directory_tree" %}',
        method: 'GET',
        data: {
            repo_id: repositoryId
        },
        success: function(response) {
            console.log('目录树API响应:', response);
            if (response && response.children && Array.isArray(response.children)) {
                if (response.children.length > 0) {
                    if (typeof window.initTree === 'function') {
                        console.log('调用 initTree 函数渲染目录树');
                        window.initTree(response.children);
                    } else {
                        console.log('使用备用方法渲染目录树');
                        renderDirectoryTree(response.children);
                    }
                } else {
                    $('#directory-tree').html('<p class="text-muted text-warning">该仓库暂无文件</p>');
                }
            } else {
                $('#directory-tree').html('<p class="text-danger">加载文件失败: 无效的目录结构</p>');
            }
        },
        error: function(xhr) {
            $('#directory-tree').html('<p class="text-danger">加载文件失败</p>');
            console.error('加载仓库文件失败');
        }
    });
}

// 渲染目录树（备用方法）
function renderDirectoryTree(files) {
    const $container = $('#directory-tree');
    $container.empty();
    
    if (!files || files.length === 0) {
        $container.html('<p class="text-muted">该仓库没有文件</p>');
        return;
    }
    
    const $list = $('<ul class="list-group"></ul>');
    
    files.forEach(function(file) {
        const isDir = file.type === 'folder';
        const iconClass = isDir ? 'bi-folder' : 'bi-file-text';
        const $item = $('<li class="list-group-item ' + (isDir ? 'bg-light' : '') + '"><i class="bi ' + iconClass + ' me-2"></i>' + (file.text || file.name) + '</li>');
        
        if (!isDir) {
            $item.addClass('file-link').data('path', file.id);
            $item.css('cursor', 'pointer');
        }
        
        $list.append($item);
    });
    
    $container.append($list);
    
    // 绑定文件点击事件
    $container.find('.file-link').click(function(e) {
        e.preventDefault();
        const filePath = $(this).data('path');
        loadFileContent(filePath);
    });
}

// 文件点击事件
function loadFileContent(filePath) {
    console.log('Loading file:', filePath);
    if (typeof window.loadFile === 'function') {
        window.loadFile(filePath);
    } else {
        console.error('window.loadFile 函数未定义');
    }
}
</script>
{% endblock %}