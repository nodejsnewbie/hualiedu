{% extends 'base.html' %}
{% load static %}

{% block title %}仓库管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
<style>
.repository-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #fff;
    transition: box-shadow 0.2s;
}

.repository-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.repository-type-badge {
    font-size: 0.8em;
    padding: 4px 8px;
}

.repository-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.sync-status {
    font-size: 0.9em;
    color: #6c757d;
}

.modal-body .form-group {
    margin-bottom: 1rem;
}

.repository-path {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 页面标题 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-folder2-open"></i> 仓库管理</h2>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRepositoryModal">
                    <i class="bi bi-plus-circle"></i> 添加仓库
                </button>
            </div>

            <!-- 仓库列表 -->
            <div id="repositoryList">
                {% if repositories %}
                    {% for repo in repositories %}
                    <div class="repository-card" data-repo-id="{{ repo.id }}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="mb-0 me-3">{{ repo.name }}</h5>
                                    <span class="badge repository-type-badge {% if repo.repo_type == 'git' %}bg-success{% else %}bg-info{% endif %}">
                                        {% if repo.repo_type == 'git' %}
                                            <i class="bi bi-git"></i> Git仓库
                                        {% else %}
                                            <i class="bi bi-folder"></i> 文件系统
                                        {% endif %}
                                    </span>
                                    {% if repo.class_obj %}
                                    <span class="badge bg-secondary ms-2">
                                        <i class="bi bi-people"></i> {{ repo.class_obj.name }}
                                    </span>
                                    {% endif %}
                                </div>

                                <div class="repository-path mb-2">
                                    <i class="bi bi-folder"></i> {{ repo.get_display_path }}
                                </div>

                                {% if repo.description %}
                                <p class="text-muted mb-2">{{ repo.description }}</p>
                                {% endif %}

                                <div class="sync-status">
                                    <i class="bi bi-clock"></i> 创建时间: {{ repo.created_at|date:"Y-m-d H:i" }}
                                    {% if repo.last_sync %}
                                        | <i class="bi bi-arrow-repeat"></i> 最后同步: {{ repo.last_sync|date:"Y-m-d H:i" }}
                                    {% endif %}
                                    {% if repo.repo_type == 'filesystem' %}
                                        | <i class="bi bi-hdd"></i> 分配空间: {{ repo.allocated_space_mb }}MB
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4 text-end">
                                <div class="repository-actions">
                                    {% if repo.repo_type == 'git' %}
                                    <button type="button" class="btn btn-outline-success btn-sm sync-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-arrow-repeat"></i> 同步
                                    </button>
                                    {% endif %}
                                    
                                    <button type="button" class="btn btn-outline-info btn-sm validate-structure-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-check-circle"></i> 验证结构
                                    </button>

                                    <button type="button" class="btn btn-outline-primary btn-sm edit-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}"
                                            data-repo-path="{{ repo.filesystem_path|default:repo.path }}" 
                                            data-repo-url="{{ repo.git_url|default:repo.url }}"
                                            data-repo-branch="{{ repo.git_branch|default:repo.branch }}" 
                                            data-repo-description="{{ repo.description }}"
                                            data-repo-type="{{ repo.repo_type }}"
                                            data-class-id="{{ repo.class_obj.id|default:'' }}">
                                        <i class="bi bi-pencil"></i> 编辑
                                    </button>

                                    <button type="button" class="btn btn-outline-danger btn-sm delete-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-folder2-open" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h4 class="text-muted mt-3">暂无仓库</h4>
                        <p class="text-muted">点击上方"添加仓库"按钮创建您的第一个仓库</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 添加仓库模态框 -->
<div class="modal fade" id="addRepositoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 添加仓库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRepositoryForm">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="repoName" class="form-label">仓库名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="repoName" name="name" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="repoClass" class="form-label">关联班级</label>
                        <select class="form-select" id="repoClass" name="class_id">
                            <option value="">不关联班级</option>
                            {% for class in classes %}
                            <option value="{{ class.id }}">{{ class.course.name }} - {{ class.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">可选：将仓库关联到特定班级</div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="repoType" class="form-label">仓库类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="repoType" name="repo_type" required>
                            <option value="filesystem">文件系统</option>
                            <option value="git">Git仓库</option>
                        </select>
                    </div>

                    <!-- Git仓库字段 -->
                    <div id="gitFields" style="display: none;">
                        <div class="form-group mb-3">
                            <label for="gitUrl" class="form-label">Git仓库URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="gitUrl" name="git_url"
                                   placeholder="https://github.com/user/repo.git">
                        </div>

                        <div class="form-group mb-3">
                            <label for="gitBranch" class="form-label">默认分支</label>
                            <input type="text" class="form-control" id="gitBranch" name="git_branch"
                                   value="main" placeholder="main">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="gitUsername" class="form-label">Git用户名（可选）</label>
                            <input type="text" class="form-control" id="gitUsername" name="git_username"
                                   placeholder="用于私有仓库认证">
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="gitPassword" class="form-label">Git密码/Token（可选）</label>
                            <input type="password" class="form-control" id="gitPassword" name="git_password"
                                   placeholder="用于私有仓库认证">
                        </div>
                        
                        <div class="form-group mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="validateGitBtn">
                                <i class="bi bi-check-circle"></i> 验证Git连接
                            </button>
                            <span id="gitValidationResult" class="ms-2"></span>
                        </div>
                    </div>

                    <!-- 文件系统字段 -->
                    <div id="filesystemFields">
                        <div class="form-group mb-3">
                            <label for="allocatedSpace" class="form-label">分配空间（MB）</label>
                            <input type="number" class="form-control" id="allocatedSpace" name="allocated_space_mb"
                                   value="1024" min="1" placeholder="1024">
                            <div class="form-text">为该仓库分配的存储空间</div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="repoDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="repoDescription" name="description"
                                  rows="3" placeholder="仓库描述（可选）"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveRepositoryBtn">
                    <i class="bi bi-check-circle"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑仓库模态框 -->
<div class="modal fade" id="editRepositoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 编辑仓库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRepositoryForm">
                    {% csrf_token %}
                    <input type="hidden" id="editRepoId" name="repository_id">

                    <div class="form-group mb-3">
                        <label for="editRepoName" class="form-label">仓库名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editRepoName" name="name" required>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">仓库类型</label>
                        <input type="text" class="form-control" id="editRepoType" readonly>
                    </div>

                    <div class="form-group mb-3" id="editPathGroup">
                        <label for="editRepoPath" class="form-label">本地路径</label>
                        <input type="text" class="form-control" id="editRepoPath" name="path">
                    </div>

                    <div class="form-group mb-3" id="editUrlGroup">
                        <label for="editRepoUrl" class="form-label">Git仓库URL</label>
                        <input type="url" class="form-control" id="editRepoUrl" name="url">
                    </div>

                    <div class="form-group mb-3" id="editBranchGroup">
                        <label for="editRepoBranch" class="form-label">默认分支</label>
                        <input type="text" class="form-control" id="editRepoBranch" name="branch">
                    </div>

                    <div class="form-group mb-3">
                        <label for="editRepoDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editRepoDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateRepositoryBtn">
                    <i class="bi bi-check-circle"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>

<script>
$(document).ready(function() {
    // 仓库类型切换
    $('#repoType').change(function() {
        const type = $(this).val();
        if (type === 'git') {
            $('#filesystemFields').hide();
            $('#gitFields').show();
            $('#gitUrl').attr('required', true);
        } else {
            $('#filesystemFields').show();
            $('#gitFields').hide();
            $('#gitUrl').removeAttr('required');
        }
    });
    
    // 验证Git连接
    $('#validateGitBtn').click(function() {
        const btn = $(this);
        const resultSpan = $('#gitValidationResult');
        
        const gitUrl = $('#gitUrl').val().trim();
        const gitBranch = $('#gitBranch').val().trim() || 'main';
        const gitUsername = $('#gitUsername').val().trim();
        const gitPassword = $('#gitPassword').val();
        
        if (!gitUrl) {
            resultSpan.html('<span class="text-danger">请输入Git仓库URL</span>');
            return;
        }
        
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> 验证中...');
        resultSpan.html('');
        
        $.ajax({
            url: '{% url "grading:validate_git_connection" %}',
            method: 'POST',
            data: {
                'git_url': gitUrl,
                'git_branch': gitBranch,
                'git_username': gitUsername,
                'git_password': gitPassword,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    resultSpan.html('<span class="text-success"><i class="bi bi-check-circle-fill"></i> ' + response.message + '</span>');
                } else {
                    resultSpan.html('<span class="text-danger"><i class="bi bi-x-circle-fill"></i> ' + response.message + '</span>');
                }
            },
            error: function(xhr) {
                resultSpan.html('<span class="text-danger"><i class="bi bi-x-circle-fill"></i> 验证请求失败</span>');
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> 验证Git连接');
            }
        });
    });

    // 保存仓库
    $('#saveRepositoryBtn').click(function() {
        const formData = new FormData($('#addRepositoryForm')[0]);

        $.ajax({
            url: '{% url "grading:add_repository" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert('仓库创建成功！');
                    location.reload();
                } else {
                    alert('错误：' + response.message);
                }
            },
            error: function(xhr) {
                alert('请求失败，请重试');
            }
        });
    });

    // 编辑仓库
    $('.edit-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');
        const repoPath = $(this).data('repo-path');
        const repoUrl = $(this).data('repo-url');
        const repoBranch = $(this).data('repo-branch');
        const repoDescription = $(this).data('repo-description');
        const repoType = $(this).data('repo-type');

        $('#editRepoId').val(repoId);
        $('#editRepoName').val(repoName);
        $('#editRepoPath').val(repoPath);
        $('#editRepoUrl').val(repoUrl);
        $('#editRepoBranch').val(repoBranch);
        $('#editRepoDescription').val(repoDescription);
        $('#editRepoType').val(repoType === 'git' ? 'Git仓库' : '本地目录');

        // 根据类型显示/隐藏字段
        if (repoType === 'git') {
            $('#editPathGroup').hide();
            $('#editUrlGroup').show();
            $('#editBranchGroup').show();
        } else {
            $('#editPathGroup').show();
            $('#editUrlGroup').hide();
            $('#editBranchGroup').hide();
        }

        $('#editRepositoryModal').modal('show');
    });

    // 更新仓库
    $('#updateRepositoryBtn').click(function() {
        const formData = new FormData($('#editRepositoryForm')[0]);

        $.ajax({
            url: '{% url "grading:update_repository" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert('仓库更新成功！');
                    location.reload();
                } else {
                    alert('错误：' + response.message);
                }
            },
            error: function(xhr) {
                alert('请求失败，请重试');
            }
        });
    });

    // 删除仓库
    $('.delete-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');

        if (confirm(`确定要删除仓库 "${repoName}" 吗？`)) {
            $.ajax({
                url: '{% url "grading:delete_repository" %}',
                method: 'POST',
                data: {
                    'repository_id': repoId,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('仓库删除成功！');
                        location.reload();
                    } else {
                        alert('错误：' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('请求失败，请重试');
                }
            });
        }
    });

    // 同步仓库
    $('.sync-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');
        const btn = $(this);

        btn.prop('disabled', true).html('<i class="bi bi-arrow-repeat spin"></i> 同步中...');

        $.ajax({
            url: '{% url "grading:sync_repository" %}',
            method: 'POST',
            data: {
                'repository_id': repoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                alert(response.message);
                if (response.status === 'success') {
                    location.reload();
                }
            },
            error: function(xhr) {
                alert('同步失败，请重试');
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-arrow-repeat"></i> 同步');
            }
        });
    });
    
    // 验证目录结构
    $('.validate-structure-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');
        const btn = $(this);

        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> 验证中...');

        $.ajax({
            url: '{% url "grading:validate_directory_structure" %}',
            method: 'POST',
            data: {
                'repository_id': repoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    alert('✓ ' + response.message);
                } else {
                    let message = '✗ ' + response.message;
                    if (response.suggestions && response.suggestions.length > 0) {
                        message += '\n\n建议修复步骤：\n' + response.suggestions.join('\n');
                    }
                    alert(message);
                }
            },
            error: function(xhr) {
                alert('验证失败，请重试');
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> 验证结构');
            }
        });
    });
});
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
