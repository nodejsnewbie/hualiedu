{% extends 'base.html' %}
{% load static %}

{% block title %}仓库管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
<style>
.repository-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #fff;
    transition: box-shadow 0.2s;
}

.repository-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.repository-type-badge {
    font-size: 0.8em;
    padding: 4px 8px;
}

.repository-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.sync-status {
    font-size: 0.9em;
    color: #6c757d;
}

.modal-body .form-group {
    margin-bottom: 1rem;
}

.repository-path {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-folder2-open"></i> 仓库管理</h2>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRepositoryModal">
                    <i class="bi bi-plus-circle"></i> 添加仓库
                </button>
            </div>

            <div id="repositoryList">
                {% if repositories %}
                    {% for repo in repositories %}
                    <div class="repository-card" data-repo-id="{{ repo.id }}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="mb-0 me-3">{{ repo.name }}</h5>
                                    <span class="badge repository-type-badge {% if repo.repo_type == 'git' %}bg-success{% else %}bg-info{% endif %}">
                                        {% if repo.repo_type == 'git' %}
                                            <i class="bi bi-git"></i> Git仓库
                                        {% else %}
                                            <i class="bi bi-folder"></i> 文件系统
                                        {% endif %}
                                    </span>
                                    {% if repo.class_obj %}
                                    <span class="badge bg-secondary ms-2">
                                        <i class="bi bi-people"></i> {{ repo.class_obj.name }}
                                    </span>
                                    {% endif %}
                                </div>

                                <div class="repository-path mb-2">
                                    <i class="bi bi-folder"></i> {{ repo.get_display_path }}
                                </div>

                                {% if repo.description %}
                                <p class="text-muted mb-2">{{ repo.description }}</p>
                                {% endif %}

                                <div class="sync-status">
                                    <i class="bi bi-clock"></i> 创建时间: {{ repo.created_at|date:"Y-m-d H:i" }}
                                    {% if repo.last_sync %}
                                        | <i class="bi bi-arrow-repeat"></i> 最后同步: {{ repo.last_sync|date:"Y-m-d H:i" }}
                                    {% endif %}
                                    {% if repo.repo_type == 'filesystem' %}
                                        | <i class="bi bi-hdd"></i> 分配空间: {{ repo.allocated_space_mb }}MB
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4 text-end">
                                <div class="repository-actions">
                                    {% if repo.repo_type == 'git' %}
                                    <button type="button" class="btn btn-outline-success btn-sm sync-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-arrow-repeat"></i> 同步
                                    </button>
                                    {% endif %}

                                    <button type="button" class="btn btn-outline-info btn-sm validate-structure-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-check-circle"></i> 验证结构
                                    </button>

                                    <button type="button" class="btn btn-outline-primary btn-sm edit-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}"
                                            data-repo-path="{{ repo.filesystem_path|default:repo.path }}"
                                            data-repo-url="{{ repo.git_url|default:repo.url }}"
                                            data-repo-branch="{{ repo.git_branch|default:repo.branch }}"
                                            data-repo-description="{{ repo.description }}"
                                            data-repo-type="{{ repo.repo_type }}"
                                            data-class-id="{{ repo.class_obj.id|default:'' }}">
                                        <i class="bi bi-pencil"></i> 编辑
                                    </button>

                                    <button type="button" class="btn btn-outline-danger btn-sm delete-repo-btn"
                                            data-repo-id="{{ repo.id }}" data-repo-name="{{ repo.name }}">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-folder2-open" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h4 class="text-muted mt-3">暂无仓库</h4>
                        <p class="text-muted">点击上方“添加仓库”按钮创建您的第一个仓库。</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 添加仓库模态框 -->
<div class="modal fade" id="addRepositoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 添加仓库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRepositoryForm">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="repoUrl" class="form-label">仓库链接 <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="repoUrl" name="repo_url" required
                               placeholder="https://github.com/user/repo.git or git@github.com:user/repo.git">
                        <div class="form-text">只需提供仓库链接，系统会自动识别协议和仓库名称。</div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="repoName" class="form-label">仓库名称</label>
                        <input type="text" class="form-control" id="repoName" name="name"
                               placeholder="留空则从链接自动识别">
                    </div>

                    <div class="form-group mb-3" id="repoAuthFields" style="display: none;">
                        <label class="form-label">认证信息（如需）</label>
                        <input type="text" class="form-control mb-2" id="gitUsername" name="git_username"
                               placeholder="Git 用户名 / 账号（HTTPS 私有仓库）">
                        <input type="password" class="form-control" id="gitPassword" name="git_password"
                               placeholder="Git 密码 / Token（HTTPS 私有仓库）">
                        <div class="form-text">HTTPS 仓库需要认证信息；如系统未保存凭据，请提供。</div>
                    </div>

                    <div class="form-group mb-3" id="repoSshKeyFields" style="display: none;">
                        <label class="form-label">SSH 公钥（如需）</label>
                        <textarea class="form-control" id="sshPublicKey" name="ssh_public_key" rows="3"
                                  placeholder="粘贴 SSH 公钥，例如：ssh-ed25519 AAAA... user@host"></textarea>
                        <input type="file" class="form-control mt-2" id="sshPublicKeyFile" name="ssh_public_key_file" accept=".pub">
                        <div class="form-text">Git@ 仓库需要 SSH 公钥；如系统未保存公钥，请提供（可上传 .pub 文件）。</div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="repo描述" class="form-label">描述</label>
                        <textarea class="form-control" id="repo描述" name="description"
                                  rows="3" placeholder="仓库描述（可选）"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveRepositoryBtn">
                    <i class="bi bi-check-circle"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑 repository modal -->
<div class="modal fade" id="editRepositoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 编辑仓库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRepositoryForm">
                    {% csrf_token %}
                    <input type="hidden" id="editRepoId" name="repository_id">

                    <div class="form-group mb-3">
                        <label for="editRepoName" class="form-label">仓库名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editRepoName" name="name" required>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">仓库类型</label>
                        <input type="text" class="form-control" id="editRepoType" readonly>
                    </div>

                    <div class="form-group mb-3" id="editPathGroup">
                        <label for="editRepoPath" class="form-label">本地路径</label>
                        <input type="text" class="form-control" id="editRepoPath" name="path">
                    </div>

                    <div class="form-group mb-3" id="editUrlGroup">
                        <label for="editRepoUrl" class="form-label">Git仓库URL</label>
                        <input type="url" class="form-control" id="editRepoUrl" name="url">
                    </div>

                    <div class="form-group mb-3" id="editBranchGroup">
                        <label for="editRepoBranch" class="form-label">默认分支</label>
                        <select class="form-select" id="editRepoBranch" name="git_branch"></select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="editRepoDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editRepoDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateRepositoryBtn">
                    <i class="bi bi-check-circle"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>

<script>
$(document).ready(function() {
    function getRepoProtocol(repoUrl) {
        const trimmed = (repoUrl || "").trim();
        if (!trimmed) {
            return "";
        }
        if (/^git@[^:]+:/.test(trimmed)) {
            return "ssh";
        }
        const match = trimmed.match(/^([a-z][a-z0-9+.-]*):\/\//i);
        return match ? match[1].toLowerCase() : "";
    }

    function updateRepoAuthFields() {
        const protocol = getRepoProtocol($('#repoUrl').val());
        const showAuthFields = protocol === "http" || protocol === "https";
        const showSshKeyFields = protocol === "ssh";
        $('#repoAuthFields').toggle(showAuthFields);
        $('#repoSshKeyFields').toggle(showSshKeyFields);
        if (!showAuthFields) {
            $('#gitUsername').val('');
            $('#gitPassword').val('');
        }
        if (!showSshKeyFields) {
            $('#sshPublicKey').val('');
            $('#sshPublicKeyFile').val('');
        }
    }

    $('#repoUrl').on('input', updateRepoAuthFields);
    $('#addRepositoryModal').on('shown.bs.modal', updateRepoAuthFields);
    $('#sshPublicKeyFile').on('change', function(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
            return;
        }
        const reader = new FileReader();
        reader.onload = function(loadEvent) {
            $('#sshPublicKey').val((loadEvent.target && loadEvent.target.result) || '');
        };
        reader.readAsText(file);
    });

    function loadRepoBranches(repoId, currentBranch) {
        $('#editRepoBranch').empty().append('<option value="">加载中...</option>');
        $.ajax({
            url: '{% url "grading:get_repository_branches" %}',
            method: 'GET',
            data: { repo_id: repoId },
            success: function(response) {
                if (response.status === 'success') {
                    const branches = response.branches || [];
                    $('#editRepoBranch').empty();
                    if (branches.length === 0) {
                        $('#editRepoBranch').append('<option value="">未找到分支</option>');
                        return;
                    }
                    branches.forEach(function(branch) {
                        const selected = branch === currentBranch ? ' selected' : '';
                        $('#editRepoBranch').append(
                            `<option value="${branch}"${selected}>${branch}</option>`
                        );
                    });
                } else {
                    $('#editRepoBranch').empty().append('<option value="">分支读取失败</option>');
                }
            },
            error: function() {
                $('#editRepoBranch').empty().append('<option value="">分支读取失败</option>');
            }
        });
    }

    // 保存仓库
    $('#saveRepositoryBtn').click(function() {
        const repoUrl = $('#repoUrl').val().trim();
        if (!repoUrl) {
            alert('请输入仓库链接');
            return;
        }
        const formData = new FormData($('#addRepositoryForm')[0]);

        $.ajax({
            url: '{% url "grading:add_repository" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert('仓库创建成功！');
                    location.reload();
                } else {
                    if (response.code === 'credential_required') {
                        updateRepoAuthFields();
                        $('#gitUsername').focus();
                    }
                    if (response.code === 'credential_required_ssh') {
                        updateRepoAuthFields();
                        $('#sshPublicKey').focus();
                    }
                    if (response.code === 'credential_invalid') {
                        updateRepoAuthFields();
                        $('#gitPassword').focus();
                    }
                    alert('错误：' + response.message);
                }
            },
            error: function() {
                alert('请求失败，请重试');
            }
        });
    });

    // 编辑仓库
    $('.edit-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');
        const repoPath = $(this).data('repo-path');
        const repoUrl = $(this).data('repo-url');
        const repoBranch = $(this).data('repo-branch');
        const repoDescription = $(this).data('repo-description');
        const repoType = $(this).data('repo-type');

        $('#editRepoId').val(repoId);
        $('#editRepoName').val(repoName);
        $('#editRepoPath').val(repoPath);
        $('#editRepoUrl').val(repoUrl);
        $('#editRepoDescription').val(repoDescription);
        $('#editRepoType').val(repoType === 'git' ? 'Git仓库' : '本地目录');

        if (repoType === 'git') {
            $('#editPathGroup').hide();
            $('#editUrlGroup').show();
            $('#editBranchGroup').show();
            loadRepoBranches(repoId, repoBranch);
        } else {
            $('#editPathGroup').show();
            $('#editUrlGroup').hide();
            $('#editBranchGroup').hide();
        }

        $('#editRepositoryModal').modal('show');
    });

    // 更新 repository
    $('#updateRepositoryBtn').click(function() {
        const formData = new FormData($('#editRepositoryForm')[0]);

        $.ajax({
            url: '{% url "grading:update_repository" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert('仓库更新成功！');
                    location.reload();
                } else {
                    alert('错误：' + response.message);
                }
            },
            error: function() {
                alert('请求失败，请重试');
            }
        });
    });

    // 确定要删除仓库
    $('.delete-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const repoName = $(this).data('repo-name');

        if (confirm(`确定要删除仓库 "${repoName}"?`)) {
            $.ajax({
                url: '{% url "grading:delete_repository" %}',
                method: 'POST',
                data: {
                    'repository_id': repoId,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('仓库删除成功！');
                        location.reload();
                    } else {
                        alert('错误：' + response.message);
                    }
                },
                error: function() {
                    alert('请求失败，请重试');
                }
            });
        }
    });

    // 同步 repository
    $('.sync-repo-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const btn = $(this);

        btn.prop('disabled', true).html('<i class="bi bi-arrow-repeat spin"></i> 同步中...');

        $.ajax({
            url: '{% url "grading:sync_repository" %}',
            method: 'POST',
            data: {
                'repository_id': repoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                alert(response.message);
                if (response.status === 'success') {
                    location.reload();
                }
            },
            error: function() {
                alert('同步失败，请重试');
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-arrow-repeat"></i> 同步');
            }
        });
    });

    // 验证目录结构
    $('.validate-structure-btn').click(function() {
        const repoId = $(this).data('repo-id');
        const btn = $(this);

        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> 验证中...');

        $.ajax({
            url: '{% url "grading:validate_directory_structure" %}',
            method: 'POST',
            data: {
                'repository_id': repoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    alert('✅ ' + response.message);
                } else {
                    let message = '⚠️ ' + response.message;
                    if (response.suggestions && response.suggestions.length > 0) {
                        message += '\n\n建议修复步骤：\n' + response.suggestions.join('\n');
                    }
                    alert(message);
                }
            },
            error: function() {
                alert('验证失败，请重试');
            },
            complete: function() {
                btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> 验证结构');
            }
        });
    });
});
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
