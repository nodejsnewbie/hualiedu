---
inclusion: always
---

# Project Structure & Organization

## Directory Organization

```
huali-edu/
├── grading/              # Core application - grading system
├── toolbox/              # Utility application - helper tools
├── hualiEdu/             # Django project configuration
├── templates/            # Global templates
├── static/               # Static files (development)
├── staticfiles/          # Static files (production, generated)
├── media/                # User uploaded files
├── docs/                 # Project documentation
├── tests/                # Project-level integration tests
├── scripts/              # Manual test and utility scripts
└── logs/                 # Application logs
```

## Application Structure

### grading/ (Core App)
```
grading/
├── management/           # Django management commands
│   └── commands/         # Custom commands
├── migrations/           # Database migrations
├── services/             # Business logic layer
│   ├── semester_*.py     # Semester management services
│   └── ...
├── static/grading/       # App-specific static files
├── templates/            # App-specific templates
├── templatetags/         # Custom template tags
├── tests/                # App-specific tests
├── admin.py              # Admin interface configuration
├── models.py             # Data models
├── views.py              # View functions
├── urls.py               # URL routing
├── forms.py              # Form definitions
├── utils.py              # Utility functions
├── middleware.py         # Custom middleware (multi-tenant)
└── exceptions.py         # Custom exceptions
```

### Model Relationships
- Tenant → UserProfile, Repository, Submission, GradeTypeConfig
- User → UserProfile, Repository, Course
- Semester → Course, SemesterTemplate
- Course → CourseSchedule, Homework
- Repository → Submission

## File Organization

### Test Files
- `<app>/tests/test_*.py` - App-specific automated tests
- `tests/test_*.py` - Cross-app integration tests
- `scripts/manual_test_*.py` - Manual testing only (not CI/CD)

### Static & Media Files
- `static/` and `<app>/static/<app>/` - Development static files
- `staticfiles/` - Production (generated by collectstatic)
- `media/` - User uploads (assignments, grades, ssh_keys)

### Templates
- `templates/` - Global base templates
- `<app>/templates/<app>/` - App-specific templates
- `templates/admin/` - Admin interface overrides

### Documentation
- `docs/` - All project documentation
- Keep README files synchronized with code changes

## Naming Conventions

- **Modules**: `lowercase_with_underscores.py`
- **Classes**: `PascalCase`
- **Functions/Variables**: `lowercase_with_underscores`
- **Constants**: `UPPERCASE_WITH_UNDERSCORES`
- **Private**: `_leading_underscore`
- **Models**: Singular (e.g., `Student`, not `Students`)
- **URLs**: lowercase-with-hyphens (e.g., `/student-grades/`)
- **Templates**: lowercase_with_underscores.html
- **DB Tables**: Use `db_table` in Meta (e.g., `grading_student`)



## File Cleanup

### Never Commit
- Backup: `*.backup`, `*.bak`, `*_backup*`
- Temp: `*.tmp`, `*_temp*`, `*_old*`
- Debug: `debug_*`, `*_debug*`
- IDE: `.DS_Store`, `__pycache__/`, `*.pyc`
- Secrets: `.env`
- Database: `*.sqlite3` (dev only)
- Logs: `logs/*.log`

### Code Hygiene
- Remove unused imports
- Delete commented code
- Remove debug print statements
- Clean test data in tearDown()

## Import Organization

Use isort with black profile:
```python
# Standard library
import os
from datetime import datetime

# Third-party
from django.db import models
from django.contrib.auth.models import User

# Local application
from grading.models import Student
from grading.services.semester_manager import SemesterManager
```

## Architecture Patterns

### Services Layer
- Business logic in `services/`, NOT in views
- Views: HTTP request/response only
- Services: Business logic, multi-model operations
- Models: Data structure, simple queries

### Multi-Tenant
- Middleware sets `request.tenant` on every request
- All tenant-scoped models have `tenant` ForeignKey
- **ALWAYS** filter by tenant: `Model.objects.filter(tenant=request.tenant)`
- Tenant configs override global configs

### Repository Pattern
- **Git**: Remote URL + branch tracking
- **Local**: File system paths `<base>/<username>/<repo_name>`

## Critical Rules

1. **Never edit existing migrations** - Create new ones
2. **Always filter by tenant** - Data isolation is critical
3. **Services for business logic** - Keep views thin
4. **Log, don't print** - Use Django logger
5. **Environment variables** - Never hardcode secrets
6. **Test location matters** - `<app>/tests/` (unit), `tests/` (integration), `scripts/` (manual)
