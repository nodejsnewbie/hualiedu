{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="{% static 'grading/images/favicon.ico' %}">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap-icons/font/bootstrap-icons.css' %}">
<!-- jstree CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/themes/default/style.min.css' %}">
<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-file-earmark-spreadsheet"></i> 作业成绩写入成绩登分册
            </h1>
            <p class="text-muted">
                选择班级目录，系统将自动扫描目录下的作业成绩文件，并将成绩写入成绩登分册。
            </p>
        </div>
    </div>

    <div class="row">
        <!-- 左侧：目录选择器 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-folder-tree"></i> 选择班级目录
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 仓库选择 -->
                    <div class="mb-3">
                        <label for="repository-select" class="form-label">选择仓库</label>
                        <select class="form-select" id="repository-select">
                            <option value="">-- 请选择仓库 --</option>
                            {% for repo in repositories %}
                            <option value="{{ repo.id }}">{{ repo.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- 目录树 -->
                    <div id="directory-tree" class="border rounded p-2" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                        <p class="text-muted text-center mt-5">请先选择仓库</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：操作区域和结果显示 -->
        <div class="col-md-8">
            <!-- 选中目录信息 -->
            <div class="card mb-3" id="selected-dir-card" style="display: none;">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-folder-check"></i> 已选择目录
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>目录路径：</strong><span id="selected-dir-path" class="text-primary"></span></p>
                    <p class="mb-0"><strong>成绩登分册：</strong><span id="registry-file-name" class="text-success">检测中...</span></p>
                    <button type="button" class="btn btn-success mt-3" id="start-write-btn" disabled>
                        <i class="bi bi-play-circle"></i> 开始写入
                    </button>
                </div>
            </div>

            <!-- 进度显示区域 -->
            <div class="card mb-3" id="progress-card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hourglass-split"></i> 处理进度
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span id="progress-text">准备中...</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 id="progress-bar"
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div id="current-file-info" class="text-muted small">
                        <i class="bi bi-file-earmark"></i> <span id="current-file-name">-</span>
                    </div>
                </div>
            </div>

            <!-- 结果报告区域 -->
            <div class="card" id="result-card" style="display: none;">
                <div class="card-header" id="result-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-check-circle"></i> 处理结果
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 摘要信息 -->
                    <div class="row mb-4" id="result-summary">
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-primary" id="total-files">0</h3>
                                <small class="text-muted">总文件数</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-success" id="success-count">0</h3>
                                <small class="text-muted">成功</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-danger" id="failed-count">0</h3>
                                <small class="text-muted">失败</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="mb-0 text-warning" id="skipped-count">0</h3>
                                <small class="text-muted">跳过</small>
                            </div>
                        </div>
                    </div>

                    <!-- 详细结果 -->
                    <div id="result-details">
                        <!-- 成功列表 -->
                        <div id="success-section" style="display: none;">
                            <h6 class="text-success">
                                <i class="bi bi-check-circle-fill"></i> 成功写入 (<span id="success-count-text">0</span>)
                            </h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>文件名</th>
                                            <th>学生</th>
                                            <th>作业次数</th>
                                            <th>成绩</th>
                                        </tr>
                                    </thead>
                                    <tbody id="success-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 失败列表 -->
                        <div id="failed-section" style="display: none;">
                            <h6 class="text-danger">
                                <i class="bi bi-x-circle-fill"></i> 失败 (<span id="failed-count-text">0</span>)
                            </h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>文件名</th>
                                            <th>错误原因</th>
                                        </tr>
                                    </thead>
                                    <tbody id="failed-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 跳过列表 -->
                        <div id="skipped-section" style="display: none;">
                            <h6 class="text-warning">
                                <i class="bi bi-exclamation-triangle-fill"></i> 跳过 (<span id="skipped-count-text">0</span>)
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>文件名</th>
                                            <th>原因</th>
                                        </tr>
                                    </thead>
                                    <tbody id="skipped-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="mt-4">
                        <button type="button" class="btn btn-primary" id="new-write-btn">
                            <i class="bi bi-arrow-repeat"></i> 重新写入
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<!-- jstree JavaScript -->
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>
<!-- Grade Registry Writer JavaScript -->
<script src="{% static 'grading/js/grade_registry_writer.js' %}"></script>

<script>
    // 设置 CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        }
    });
</script>
{% endblock %}
