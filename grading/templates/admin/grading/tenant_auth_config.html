{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:grading_tenantconfig_changelist' %}">ç§Ÿæˆ·é…ç½®</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module aligned">
        <h2>ğŸ” Gitè®¤è¯é…ç½® - {{ tenant.name }}</h2>
        
        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <fieldset class="module aligned">
                <h2>SSHè®¤è¯é…ç½®</h2>
                <div class="form-row">
                    <div>
                        <label for="id_ssh_private_key_file">SSHç§é’¥æ–‡ä»¶:</label>
                        <input type="file" name="ssh_private_key_file" id="id_ssh_private_key_file" accept=".pem,.key,.rsa,*" class="ssh-key-file-input">
                        <p class="help">é€‰æ‹©SSHç§é’¥æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯id_rsaã€id_ed25519ç­‰ï¼‰ã€‚ç”Ÿæˆæ–¹æ³•: ssh-keygen -t rsa -b 4096</p>
                        
                        {% if auth_configs.ssh_private_key %}
                        <div class="current-key-info">
                            <p class="help" style="color: #28a745; margin-top: 10px;">
                                âœ… å½“å‰å·²é…ç½®SSHç§é’¥ ({{ auth_configs.ssh_private_key|length }} å­—ç¬¦)
                                <button type="button" class="button small" onclick="toggleKeyDisplay()" style="margin-left: 10px;">æŸ¥çœ‹/éšè—</button>
                            </p>
                            <div id="current-key-display" style="display: none; margin-top: 10px;">
                                <textarea readonly rows="6" cols="80" style="font-family: monospace; font-size: 11px; background: #f5f5f5;">{{ auth_configs.ssh_private_key }}</textarea>
                            </div>
                        </div>
                        {% else %}
                        <p class="help" style="color: #dc3545;">âŒ æœªé…ç½®SSHç§é’¥</p>
                        {% endif %}
                        
                        <div class="form-row" style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" name="clear_ssh_key" value="1"> æ¸…é™¤ç°æœ‰SSHç§é’¥
                            </label>
                            <p class="help">å‹¾é€‰æ­¤é¡¹å°†åˆ é™¤å½“å‰é…ç½®çš„SSHç§é’¥</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="id_ssh_passphrase">SSHå¯†é’¥å¯†ç :</label>
                        <input type="password" name="config_ssh_key_passphrase" id="id_ssh_passphrase" value="{{ auth_configs.ssh_key_passphrase }}" placeholder="å¦‚æœSSHå¯†é’¥æœ‰å¯†ç ï¼Œè¯·è¾“å…¥">
                        <p class="help">SSHç§é’¥çš„å¯†ç ï¼ˆå¦‚æœè®¾ç½®äº†çš„è¯ï¼‰</p>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="module aligned">
                <h2>HTTPSè®¤è¯é…ç½®</h2>
                <div class="form-row">
                    <div>
                        <label for="id_https_username">ç”¨æˆ·å:</label>
                        <input type="text" name="config_https_username" id="id_https_username" value="{{ auth_configs.https_username }}" placeholder="GitæœåŠ¡å™¨ç”¨æˆ·å">
                        <p class="help">GitHub/GitLabç­‰GitæœåŠ¡å™¨çš„ç”¨æˆ·å</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="id_https_password">å¯†ç :</label>
                        <input type="password" name="config_https_password" id="id_https_password" value="{{ auth_configs.https_password }}" placeholder="å¯†ç ï¼ˆä¸æ¨èï¼‰">
                        <p class="help">GitæœåŠ¡å™¨å¯†ç ï¼ˆä¸æ¨èï¼Œå»ºè®®ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œï¼‰</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="id_https_token">ä¸ªäººè®¿é—®ä»¤ç‰Œ:</label>
                        <input type="password" name="config_https_token" id="id_https_token" value="{{ auth_configs.https_token }}" placeholder="ghp_xxxxxxxxxxxx">
                        <p class="help">ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆæ¨èï¼‰ã€‚GitHub: Settings â†’ Developer settings â†’ Personal access tokens</p>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="module aligned">
                <h2>Gitç”¨æˆ·é…ç½®</h2>
                <div class="form-row">
                    <div>
                        <label for="id_git_user_name">Gitç”¨æˆ·å:</label>
                        <input type="text" name="config_git_user_name" id="id_git_user_name" value="{{ auth_configs.git_user_name }}" placeholder="æäº¤æ—¶æ˜¾ç¤ºçš„ç”¨æˆ·å">
                        <p class="help">Gitæäº¤æ—¶ä½¿ç”¨çš„ç”¨æˆ·å</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="id_git_user_email">Gité‚®ç®±:</label>
                        <input type="email" name="config_git_user_email" id="id_git_user_email" value="{{ auth_configs.git_user_email }}" placeholder="user@example.com">
                        <p class="help">Gitæäº¤æ—¶ä½¿ç”¨çš„é‚®ç®±åœ°å€</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="id_default_auth_method">é»˜è®¤è®¤è¯æ–¹å¼:</label>
                        <select name="config_default_auth_method" id="id_default_auth_method">
                            <option value="https" {% if auth_configs.default_auth_method == 'https' %}selected{% endif %}>HTTPS</option>
                            <option value="ssh" {% if auth_configs.default_auth_method == 'ssh' %}selected{% endif %}>SSH</option>
                        </select>
                        <p class="help">ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨çš„è®¤è¯æ–¹å¼</p>
                    </div>
                </div>
            </fieldset>
            
            <div class="submit-row">
                <input type="submit" value="ä¿å­˜é…ç½®" class="default" name="_save">
                <a href="{% url 'admin:grading_tenantconfig_changelist' %}" class="button cancel-link">è¿”å›</a>
            </div>
        </form>
        
        <div class="module">
            <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
            <ul>
                <li><strong>SSHæ–¹å¼</strong>: ç”ŸæˆSSHå¯†é’¥å¯¹ï¼Œå°†ç§é’¥å¡«å…¥ä¸Šæ–¹ï¼Œå…¬é’¥æ·»åŠ åˆ°GitæœåŠ¡å™¨</li>
                <li><strong>HTTPSæ–¹å¼</strong>: æ¨èä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œï¼Œæ¯”å¯†ç æ›´å®‰å…¨</li>
                <li><strong>è‡ªåŠ¨é€‰æ‹©</strong>: ç³»ç»Ÿä¼šæ ¹æ®ä»“åº“URLå’Œæ‚¨çš„é…ç½®è‡ªåŠ¨é€‰æ‹©è®¤è¯æ–¹å¼</li>
                <li><strong>URLè½¬æ¢</strong>: ç³»ç»Ÿå¯ä»¥åœ¨SSHå’ŒHTTPS URLä¹‹é—´è‡ªåŠ¨è½¬æ¢</li>
            </ul>
        </div>
    </div>
</div>

<style>
.form-row textarea, .form-row input[type="text"], .form-row input[type="password"], .form-row input[type="email"], .form-row select {
    width: 100%;
    max-width: 600px;
}
.form-row textarea {
    font-family: monospace;
    font-size: 12px;
}
.ssh-key-file-input {
    width: 100%;
    max-width: 600px;
    padding: 8px;
    border: 2px dashed #ddd;
    border-radius: 4px;
    background: #fafafa;
    cursor: pointer;
    transition: border-color 0.3s;
}
.ssh-key-file-input:hover {
    border-color: #79aec8;
    background: #f0f8ff;
}
.ssh-key-file-input:focus {
    outline: none;
    border-color: #79aec8;
    box-shadow: 0 0 5px rgba(121, 174, 200, 0.3);
}
.current-key-info {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    margin-top: 10px;
}
.button.small {
    padding: 4px 8px;
    font-size: 11px;
    background: #79aec8;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}
.button.small:hover {
    background: #609ab6;
}
.help {
    color: #666;
    font-size: 11px;
    margin-top: 2px;
}
fieldset {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
fieldset h2 {
    margin-top: 0;
    color: #333;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}
</style>

<script>
function toggleKeyDisplay() {
    const display = document.getElementById('current-key-display');
    if (display.style.display === 'none') {
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

// æ–‡ä»¶ä¸Šä¼ é¢„è§ˆ
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_ssh_private_key_file');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º100KBï¼‰
                if (file.size > 100 * 1024) {
                    alert('SSHç§é’¥æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ç¡®è®¤é€‰æ‹©äº†æ­£ç¡®çš„ç§é’¥æ–‡ä»¶');
                    return;
                }
                
                // è¯»å–æ–‡ä»¶å†…å®¹è¿›è¡ŒåŸºæœ¬éªŒè¯
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (!content.includes('BEGIN') || !content.includes('PRIVATE KEY')) {
                        if (!confirm('é€‰æ‹©çš„æ–‡ä»¶å¯èƒ½ä¸æ˜¯SSHç§é’¥æ–‡ä»¶ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                            fileInput.value = '';
                            return;
                        }
                    }
                };
                reader.readAsText(file);
            }
        });
    }
});
</script>
{% endblock %}