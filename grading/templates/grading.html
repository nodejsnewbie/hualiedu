{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="{% static 'grading/images/favicon.ico' %}">
<!-- jstree CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/jstree/jstree.min.css' %}">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="{% static 'grading/vendor/bootstrap/bootstrap.min.css' %}">
<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'grading/css/custom.css' %}">
<!-- CodeMirror -->
<link rel="stylesheet" href="{% static 'grading/vendor/codemirror/codemirror.min.css' %}">
<!-- Viewer.js -->
<link rel="stylesheet" href="{% static 'grading/vendor/viewerjs/viewer.min.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧文件树 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">文件目录</h5>
                </div>
                <div class="card-body">
                    <div id="directory-tree"></div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">文件内容</h5>
                    <div class="file-count-display text-muted small">
                        <span id="directory-file-count">0</span> 个文件
                    </div>
                </div>
                <div class="card-body">
                    <!-- 加载指示器 -->
                    <div id="loading" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>

                    <!-- 文件内容显示区域 -->
                    <div id="file-content" class="mt-3">
                        {% if error %}
                            <div class="alert alert-danger">
                                {{ error }}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                请从左侧选择要评分的文件
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 评分区域 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">评分</h5>
                </div>
                <div class="card-body">
                    <!-- 文件导航按钮 -->
                    <div class="d-flex justify-content-between mb-3">
                        <button type="button" class="btn btn-outline-secondary" id="prev-file">
                            <i class="bi bi-arrow-left"></i> 上一个文件
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="next-file">
                            下一个文件 <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                    <!-- 评分按钮组 -->
                    <div class="d-flex align-items-center">
                        <div class="btn-group me-3" role="group" aria-label="评分选项">
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="A">A</button>
                            <button type="button" class="btn btn-outline-primary grade-button active" data-grade="B">B</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="C">C</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="D">D</button>
                            <button type="button" class="btn btn-outline-primary grade-button" data-grade="E">E</button>
                        </div>
                        <button type="button" class="btn btn-primary me-2" id="add-grade-to-file" disabled>
                            确定
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="cancel-grade">
                            撤销
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="{% static 'grading/vendor/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="{% static 'grading/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<!-- jstree JavaScript -->
<script src="{% static 'grading/vendor/jstree/jstree.min.js' %}"></script>
<!-- 自定义脚本 -->
<script src="{% static 'grading/js/grading.js' %}"></script>

<!-- 初始化数据 -->
<script>
    // 将初始数据传递给 JavaScript
    window.initialTreeData = {{ initial_tree_data|safe }};
    console.log('Initial tree data in template:', window.initialTreeData);
    
    // 设置 CSRF token
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        }
    });
</script>

<!-- CodeMirror -->
<script src="{% static 'grading/vendor/codemirror/codemirror.min.js' %}"></script>
<!-- Viewer.js -->
<script src="{% static 'grading/vendor/viewerjs/viewer.min.js' %}"></script>
<!-- PDF.js -->
<script src="{% static 'grading/vendor/pdfjs/pdf.min.js' %}"></script>

<script>
    // 设置 PDF.js worker 路径
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'grading/vendor/pdfjs/pdf.worker.min.js' %}";
</script>
{% endblock %}